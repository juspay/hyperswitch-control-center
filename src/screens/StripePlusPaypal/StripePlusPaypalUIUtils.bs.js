// Generated by ReScript, PLEASE EDIT WITH CARE

import * as React from "react";
import * as Button from "../../components/Button.bs.js";
import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as Recoil from "recoil";
import * as APIUtils from "../APIUtils/APIUtils.bs.js";
import * as GlobalVars from "../../utils/GlobalVars.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as ToastState from "../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as GatewayIcon from "../../components/custom-icons/GatewayIcon.bs.js";
import * as TestPayment from "../SDKPayment/TestPayment.bs.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as PaymentMethod from "../Connectors/ConnectorUIUtils/PaymentMethod.bs.js";
import * as ConnectorUtils from "../Connectors/ConnectorUtils.bs.js";
import * as EnumVariantHook from "../Hooks/EnumVariantHook.bs.js";
import * as HyperswitchAtom from "../../Recoils/HyperswitchAtom.bs.js";
import * as QuickStartUtils from "../Home/QuickStart/QuickStartUtils.bs.js";
import * as SDKPaymentUtils from "../SDKPayment/SDKPaymentUtils.bs.js";
import * as QuickStartUIUtils from "../Home/QuickStart/QuickStartUIUtils.bs.js";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as MerchantAccountUtils from "../Settings/MerchantAccountUtils.bs.js";

function StripePlusPaypalUIUtils$SelectPaymentMethods(props) {
  var setButtonState = props.setButtonState;
  var setConnectorConfigureState = props.setConnectorConfigureState;
  var setInitialValues = props.setInitialValues;
  var initialValues = props.initialValues;
  var selectedConnector = props.selectedConnector;
  var updateEnumInRecoil = EnumVariantHook.useUpdateEnumInRecoil();
  var enumDetails = Recoil.useRecoilValue(HyperswitchAtom.enumVariantAtom);
  var enums = QuickStartUtils.getTypedValueFromDict(
    LogicUtils.safeParse(enumDetails),
  );
  var getURL = APIUtils.useGetURL();
  var updateAPIHook = APIUtils.useUpdateMethod(undefined, undefined);
  var showToast = ToastState.useShowToast();
  var postEnumDetails = EnumVariantHook.usePostEnumDetails();
  var connectorName = ConnectorUtils.getConnectorNameString(selectedConnector);
  var match = React.useState(function () {
    return ConnectorUtils.getPaymentMethodEnabled({});
  });
  var setPaymentMethods = match[1];
  var paymentMethodsEnabled = match[0];
  var match$1 = React.useState(function () {
    return {};
  });
  var setMetaData = match$1[1];
  var metaData = match$1[0];
  var updateDetails = function (value) {
    setPaymentMethods(function (param) {
      return value.slice();
    });
  };
  var updateEnumForMultipleConfigurationType = async function (
    connectorChoiceValue,
  ) {
    try {
      await postEnumDetails(
        {
          TAG: "StringEnumType",
          _0: connectorChoiceValue,
        },
        "ConfigurationType",
      );
      return;
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        return Js_exn.raiseError(
          Core__Option.getOr(e._1.message, "Failed to update!"),
        );
      }
      throw e;
    }
  };
  var updateEnumForConnector = async function (connectorResponse) {
    var enums = QuickStartUtils.getTypedValueFromDict(
      LogicUtils.safeParse(enumDetails),
    );
    try {
      var processorVal_processorID = LogicUtils.getString(
        connectorResponse,
        "merchant_connector_id",
        "",
      );
      var processorVal_processorName = LogicUtils.getString(
        connectorResponse,
        "connector_name",
        "",
      );
      var processorVal = {
        processorID: processorVal_processorID,
        processorName: processorVal_processorName,
      };
      var body = {
        TAG: "ProcesorType",
        _0: processorVal,
      };
      var enumRecoilUpdateArr = [];
      if (enums.firstProcessorConnected.processorID.length === 0) {
        await postEnumDetails(body, "FirstProcessorConnected");
        enumRecoilUpdateArr.push([body, "FirstProcessorConnected"]);
      } else if (enums.secondProcessorConnected.processorID.length === 0) {
        await postEnumDetails(body, "SecondProcessorConnected");
        enumRecoilUpdateArr.push([body, "SecondProcessorConnected"]);
      }
      if (selectedConnector.TAG === "Processors") {
        switch (selectedConnector._0) {
          case "STRIPE":
            enumRecoilUpdateArr.push([body, "StripeConnected"]);
            break;
          case "PAYPAL":
            enumRecoilUpdateArr.push([body, "PaypalConnected"]);
            break;
          default:
        }
      }
      updateEnumInRecoil(enumRecoilUpdateArr);
      return;
    } catch (exn) {
      return setButtonState(function (param) {
        return "Normal";
      });
    }
  };
  var onSubmitMain = async function () {
    setButtonState(function (param) {
      return "Loading";
    });
    try {
      var obj = {
        payment_methods_enabled: paymentMethodsEnabled,
        connector: connectorName,
        metadata: metaData,
      };
      var body = ConnectorUtils.constructConnectorRequestBody(
        obj,
        initialValues,
      );
      var connectorUrl = getURL(
        "CONNECTOR",
        "Post",
        Caml_option.some(undefined),
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      if (enums.configurationType.length === 0 && connectorName === "stripe") {
        await updateEnumForMultipleConfigurationType(
          QuickStartUtils.connectorChoiceVariantToString(
            "MultipleProcessorWithSmartRouting",
          ),
        );
      }
      var response = await updateAPIHook(
        connectorUrl,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      setInitialValues(function (param) {
        return response;
      });
      updateEnumForConnector(LogicUtils.getDictFromJsonObject(response));
      setConnectorConfigureState(function (param) {
        return "Summary";
      });
      showToast(
        LogicUtils.getFirstLetterCaps(connectorName, undefined, undefined) +
          " connected successfully!",
        "ToastSuccess",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      return setButtonState(function (param) {
        return "Normal";
      });
    } catch (exn) {
      return setButtonState(function (param) {
        return "Normal";
      });
    }
  };
  React.useEffect(
    function () {
      ConnectorUtils.getConnectorPaymentMethodDetails(
        initialValues,
        setPaymentMethods,
        setMetaData,
        false,
        false,
        connectorName,
        updateDetails,
      );
    },
    [connectorName],
  );
  return React.createElement(QuickStartUIUtils.BaseComponent.make, {
    children: React.createElement(PaymentMethod.PaymentMethodsRender.make, {
      _showAdvancedConfiguration: false,
      connector: connectorName,
      paymentMethodsEnabled: paymentMethodsEnabled,
      updateDetails: updateDetails,
      setMetaData: setMetaData,
      isPayoutFlow: false,
    }),
    headerText: "Connect payment methods",
    nextButton: Caml_option.some(
      React.createElement(Button.make, {
        buttonState: props.buttonState,
        text: "Proceed",
        buttonType: "Primary",
        buttonSize: "Small",
        onClick: function (param) {
          onSubmitMain();
        },
        customButtonStyle: "rounded-md",
      }),
    ),
    backButton: Caml_option.some(
      React.createElement(Button.make, {
        text: "Back",
        buttonType: "PrimaryOutline",
        buttonSize: "Small",
        onClick: function (param) {
          setConnectorConfigureState(function (param) {
            return "Configure_keys";
          });
        },
      }),
    ),
    customIcon: Caml_option.some(
      React.createElement(GatewayIcon.make, {
        gateway: connectorName.toUpperCase(),
        className: "w-6 h-6 rounded-md",
      }),
    ),
    customCss: "show-scrollbar",
  });
}

var SelectPaymentMethods = {
  make: StripePlusPaypalUIUtils$SelectPaymentMethods,
};

function StripePlusPaypalUIUtils$TestPayment(props) {
  var setStepInView = props.setStepInView;
  var postEnumDetails = EnumVariantHook.usePostEnumDetails();
  var match = React.useState(function () {
    return "";
  });
  var setKey = match[1];
  var businessProfiles = Recoil.useRecoilValue(
    HyperswitchAtom.businessProfilesAtom,
  );
  var defaultBusinessProfile =
    MerchantAccountUtils.getValueFromBusinessProfile(businessProfiles);
  var updateTestPaymentEnum = async function (param) {
    try {
      await postEnumDetails(
        {
          TAG: "Boolean",
          _0: true,
        },
        "SPTestPayment",
      );
      return setStepInView(function (param) {
        return "COMPLETED_STRIPE_PAYPAL";
      });
    } catch (exn) {
      return;
    }
  };
  var sptestPaymentProceed = async function (param) {
    updateTestPaymentEnum();
  };
  React.useEffect(function () {
    setKey(function (param) {
      return Date.now().toString();
    });
  }, []);
  return React.createElement(QuickStartUIUtils.BaseComponent.make, {
    children: React.createElement(TestPayment.make, {
      returnUrl: GlobalVars.getHostUrlWithBasePath + "/stripe-plus-paypal",
      onProceed: sptestPaymentProceed,
      sdkWidth: "w-full",
      paymentStatusStyles: "p-0",
      keyValue: match[0],
      initialValues: SDKPaymentUtils.initialValueForForm(
        defaultBusinessProfile,
      ),
    }),
    headerText: "Preview Checkout page",
    nextButton: Caml_option.some(
      React.createElement(Button.make, {
        text: "Skip this step",
        buttonType: "PrimaryOutline",
        buttonSize: "Small",
        onClick: function (param) {
          updateTestPaymentEnum();
        },
        customButtonStyle: "!rounded-md",
      }),
    ),
  });
}

var TestPayment$1 = {
  make: StripePlusPaypalUIUtils$TestPayment,
};

export { SelectPaymentMethods, TestPayment$1 as TestPayment };
/* react Not a pure module */
