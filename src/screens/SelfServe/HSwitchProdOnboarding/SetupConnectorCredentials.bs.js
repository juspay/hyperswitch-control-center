// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Form from "../../../utils/Form.bs.js";
import * as React from "react";
import * as Button from "../../../components/Button.bs.js";
import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as Recoil from "recoil";
import * as APIUtils from "../../APIUtils/APIUtils.bs.js";
import * as RenderIf from "../../../utils/RenderIf.bs.js";
import * as Core__List from "@rescript/core/src/Core__List.bs.js";
import * as LogicUtils from "../../../utils/LogicUtils.bs.js";
import * as ToastState from "../../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as GatewayIcon from "../../../components/custom-icons/GatewayIcon.bs.js";
import * as CheckBoxIcon from "../../../components/custom-icons/CheckBoxIcon.bs.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as FormRenderer from "../../../components/form/FormRenderer.bs.js";
import * as HSwitchUtils from "../../HSwitchUtils.bs.js";
import * as FormValuesSpy from "../../../components/form/FormValuesSpy.bs.js";
import * as ConnectorUtils from "../../Connectors/ConnectorUtils.bs.js";
import * as CommonAuthHooks from "../../../entryPoints/AuthModule/Common/CommonAuthHooks.bs.js";
import * as HyperswitchAtom from "../../../Recoils/HyperswitchAtom.bs.js";
import * as HelperComponents from "../../Helpers/HelperComponents.bs.js";
import * as JsonFlattenUtils from "../../../utils/JsonFlattenUtils.bs.js";
import * as PageLoaderWrapper from "../../Helpers/PageLoaderWrapper.bs.js";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as ProdOnboardingUtils from "./ProdOnboardingUtils.bs.js";
import * as RescriptReactRouter from "@rescript/react/src/RescriptReactRouter.bs.js";
import * as MerchantAccountUtils from "../../Settings/MerchantAccountUtils.bs.js";
import * as ProdOnboardingUIUtils from "./ProdOnboardingUIUtils.bs.js";
import * as ConnectorAccountDetailsHelper from "../../Connectors/ConnectorAccountDetailsHelper.bs.js";

var headerTextStyle = "text-xl font-semibold text-grey-700";

var subTextStyle = "text-base font-normal text-grey-700 opacity-50";

var dividerColor = "bg-grey-700 bg-opacity-20 h-px w-full";

function SetupConnectorCredentials$ConnectorDetailsForm(props) {
  var verifyErrorMessage = props.verifyErrorMessage;
  var setIsCheckboxSelected = props.setIsCheckboxSelected;
  var isCheckboxSelected = props.isCheckboxSelected;
  var connectorName = props.connectorName;
  var match = React.useState(function () {
    return false;
  });
  var match$1 = ConnectorUtils.getConnectorFields(props.connectorDetails);
  var connectorVariant = ConnectorUtils.getConnectorNameTypeFromString(
    connectorName,
    undefined,
    undefined,
  );
  var selectedConnector = React.useMemo(
    function () {
      return ConnectorUtils.getConnectorInfo(connectorVariant);
    },
    [connectorName],
  );
  var match$2 = ConnectorUtils.getSuggestedAction(
    verifyErrorMessage,
    connectorName,
  );
  return React.createElement(
    "div",
    {
      className: "flex flex-col gap-6",
    },
    React.createElement(
      "div",
      undefined,
      React.createElement(
        ConnectorAccountDetailsHelper.BusinessProfileRender.make,
        {
          isUpdateFlow: false,
          selectedConnector: connectorName,
        },
      ),
    ),
    React.createElement(
      ConnectorAccountDetailsHelper.ConnectorConfigurationFields.make,
      {
        connectorAccountFields: match$1[1],
        connector: connectorVariant,
        selectedConnector: selectedConnector,
        connectorMetaDataFields: match$1[2],
        connectorWebHookDetails: match$1[4],
        connectorLabelDetailField: match$1[5],
      },
    ),
    React.createElement(
      ConnectorAccountDetailsHelper.VerifyConnectorModal.make,
      {
        showVerifyModal: match[0],
        setShowVerifyModal: match[1],
        connector: connectorName,
        verifyErrorMessage: verifyErrorMessage,
        suggestedActionExists: match$2[1],
        suggestedAction: match$2[0],
        setVerifyDone: props.setVerifyDone,
      },
    ),
    React.createElement(RenderIf.make, {
      condition: LogicUtils.isNonEmptyString(props.checkboxText),
      children: React.createElement(
        "div",
        {
          className: "flex gap-2 items-center",
        },
        React.createElement(CheckBoxIcon.make, {
          isSelected: isCheckboxSelected,
          setIsSelected: function (param) {
            setIsCheckboxSelected(function (param) {
              return !isCheckboxSelected;
            });
          },
        }),
        React.createElement(
          "p",
          {
            className: subTextStyle,
          },
          ProdOnboardingUtils.getCheckboxText(connectorVariant),
        ),
      ),
    }),
  );
}

var ConnectorDetailsForm = {
  make: SetupConnectorCredentials$ConnectorDetailsForm,
};

function SetupConnectorCredentials(props) {
  var setConnectorID = props.setConnectorID;
  var setPageView = props.setPageView;
  var pageView = props.pageView;
  var selectedConnector = props.selectedConnector;
  var getURL = APIUtils.useGetURL();
  var showToast = ToastState.useShowToast();
  var featureFlagDetails = Recoil.useRecoilValue(
    HyperswitchAtom.featureFlagAtom,
  );
  var connectorName = ConnectorUtils.getConnectorNameString(selectedConnector);
  var match = React.useState(function () {
    return "Loading";
  });
  var setScreenState = match[1];
  var match$1 = React.useState(function () {
    return false;
  });
  var setIsCheckboxSelected = match$1[1];
  var isCheckboxSelected = match$1[0];
  var connectorVariant = ConnectorUtils.getConnectorNameTypeFromString(
    connectorName,
    undefined,
    undefined,
  );
  var match$2 = React.useState(function () {
    return null;
  });
  var setConnectorDetails = match$2[1];
  var connectorDetails = match$2[0];
  var match$3 = React.useState(function () {
    return false;
  });
  var setIsLoading = match$3[1];
  var isLoading = match$3[0];
  var match$4 = Core__Option.getOr(
    CommonAuthHooks.useCommonAuthInfo(),
    CommonAuthHooks.defaultAuthInfo,
  );
  var merchantId = match$4.merchant_id;
  var match$5 = React.useState(function () {
    return null;
  });
  var setInitialValues = match$5[1];
  var getDetails = async function () {
    try {
      await window.init();
      var val = window.getConnectorConfig(connectorName);
      setConnectorDetails(function (param) {
        return val;
      });
      return setScreenState(function (param) {
        return "Success";
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var err = Core__Option.getOr(e._1.message, "Something went wrong!");
        return setScreenState(function (param) {
          return {
            TAG: "Error",
            _0: err,
          };
        });
      }
      throw e;
    }
  };
  var url = RescriptReactRouter.useUrl(undefined, undefined);
  var updateDetails = APIUtils.useUpdateMethod(false, undefined);
  var match$6 = React.useState(function () {
    return false;
  });
  var setShowVerifyModal = match$6[1];
  var match$7 = React.useState(function () {});
  var setVerifyErrorMessage = match$7[1];
  var verifyErrorMessage = match$7[0];
  var match$8 = React.useState(function () {
    return "NoAttempt";
  });
  var setVerifyDone = match$8[1];
  var verifyDone = match$8[0];
  var connectorID = HSwitchUtils.getConnectorIDFromUrl(
    Core__List.toArray(url.path),
    "",
  );
  var checkboxText = ProdOnboardingUtils.getCheckboxText(connectorVariant);
  var match$9 = ConnectorUtils.getConnectorFields(connectorDetails);
  var connectorLabelDetailField = match$9[5];
  var connectorWebHookDetails = match$9[4];
  var isVerifyConnector = match$9[3];
  var connectorMetaDataFields = match$9[2];
  var connectorAccountFields = match$9[1];
  var bodyType = match$9[0];
  var businessProfiles = Recoil.useRecoilValue(
    HyperswitchAtom.businessProfilesAtom,
  );
  var defaultBusinessProfile =
    MerchantAccountUtils.getValueFromBusinessProfile(businessProfiles);
  var match$10 = ConnectorUtils.getSuggestedAction(
    verifyErrorMessage,
    connectorName,
  );
  React.useEffect(
    function () {
      setInitialValues(function (prevJson) {
        var prevJsonDict = LogicUtils.getDictFromJsonObject(prevJson);
        prevJsonDict["connector_label"] =
          ConnectorUtils.getConnectorNameString(selectedConnector) +
          "_" +
          defaultBusinessProfile.profile_name;
        prevJsonDict["profile_id"] = defaultBusinessProfile.profile_id;
        return prevJsonDict;
      });
    },
    [selectedConnector],
  );
  var match$11 = MerchantAccountUtils.getValueFromBusinessProfile(
    Recoil.useRecoilValue(HyperswitchAtom.businessProfilesAtom),
  );
  var profile_id = match$11.profile_id;
  var updateSetupConnectorCredentials = async function (connectorId) {
    try {
      var url = getURL(
        "USERS",
        "Post",
        undefined,
        undefined,
        "MERCHANT_DATA",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var body = ProdOnboardingUtils.getProdApiBody(
        "SetupProcessor",
        connectorId,
        undefined,
        undefined,
      );
      await updateDetails(
        url,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      return setPageView(function (param) {
        return ProdOnboardingUtils.getPageView(pageView);
      });
    } catch (exn) {
      return;
    }
  };
  var onSubmitMain = async function (values) {
    try {
      setIsLoading(function (param) {
        return true;
      });
      var url = getURL(
        "CONNECTOR",
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var dict = LogicUtils.getDictFromJsonObject(
        window.getConnectorConfig(connectorName),
      );
      var creditCardNetworkArray = ConnectorUtils.getPaymentMethodMapper(
        LogicUtils.getArrayFromDict(dict, "credit", []),
      );
      var debitCardNetworkArray = ConnectorUtils.getPaymentMethodMapper(
        LogicUtils.getArrayFromDict(dict, "debit", []),
      );
      var paymentMethodsEnabledArray = [
        {
          payment_method: "card",
          payment_method_type: "credit",
          provider: [],
          card_provider: creditCardNetworkArray,
        },
        {
          payment_method: "card",
          payment_method_type: "debit",
          provider: [],
          card_provider: debitCardNetworkArray,
        },
      ];
      var requestPayload_metadata = {};
      var requestPayload = {
        payment_methods_enabled: paymentMethodsEnabledArray,
        connector: connectorName,
        metadata: requestPayload_metadata,
      };
      var payload = ConnectorUtils.generateInitialValuesDict(
        values,
        connectorName,
        bodyType,
        undefined,
        featureFlagDetails.isLiveMode,
        undefined,
        undefined,
      );
      var body = ConnectorUtils.constructConnectorRequestBody(
        requestPayload,
        payload,
      );
      var res = await updateDetails(
        url,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var connectorId = LogicUtils.getString(
        LogicUtils.getDictFromJsonObject(res),
        "merchant_connector_id",
        "",
      );
      setConnectorID(function (param) {
        return connectorId;
      });
      updateSetupConnectorCredentials(connectorId);
      return setIsLoading(function (param) {
        return false;
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        setIsLoading(function (param) {
          return false;
        });
        setShowVerifyModal(function (param) {
          return false;
        });
        setVerifyDone(function (param) {
          return "NoAttempt";
        });
        setPageView(function (param) {
          return "SELECT_PROCESSOR";
        });
        var message = e._1.message;
        if (message !== undefined) {
          if (message.includes("HE_01")) {
            showToast(
              "This configuration already exists for the connector. Please try with a different country or label under advanced settings.",
              "ToastError",
              undefined,
              undefined,
              undefined,
              undefined,
              undefined,
              undefined,
            );
            return setScreenState(function (param) {
              return "Success";
            });
          } else {
            showToast(
              "Failed to Save the Configuration!",
              "ToastError",
              undefined,
              undefined,
              undefined,
              undefined,
              undefined,
              undefined,
            );
            return setScreenState(function (param) {
              return {
                TAG: "Error",
                _0: message,
              };
            });
          }
        } else {
          return setScreenState(function (param) {
            return {
              TAG: "Error",
              _0: "Failed to Fetch!",
            };
          });
        }
      }
      throw e;
    }
  };
  var validateMandatoryField = function (values) {
    var errors = {};
    var valuesFlattenJson = JsonFlattenUtils.flattenObject(values, true);
    return ConnectorUtils.validateConnectorRequiredFields(
      connectorVariant,
      valuesFlattenJson,
      connectorAccountFields,
      connectorMetaDataFields,
      connectorWebHookDetails,
      connectorLabelDetailField,
      errors,
    );
  };
  var onSubmitVerify = async function (values) {
    try {
      setIsLoading(function (param) {
        return true;
      });
      var body = ConnectorUtils.ignoreFields(
        ConnectorUtils.generateInitialValuesDict(
          values,
          connectorName,
          bodyType,
          false,
          featureFlagDetails.isLiveMode,
          undefined,
          undefined,
        ),
        connectorID,
        ConnectorUtils.verifyConnectorIgnoreField,
      );
      var url = getURL(
        "CONNECTOR",
        "Post",
        undefined,
        Caml_option.some(connectorName),
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      await updateDetails(
        url,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      setShowVerifyModal(function (param) {
        return false;
      });
      onSubmitMain(values);
      return setIsLoading(function (param) {
        return false;
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        setIsLoading(function (param) {
          return false;
        });
        var message = e._1.message;
        if (message === undefined) {
          return setScreenState(function (param) {
            return {
              TAG: "Error",
              _0: "Failed to Fetch!",
            };
          });
        }
        var errorMessage = JSON.parse(message);
        setVerifyErrorMessage(function (param) {
          return errorMessage.message;
        });
        setShowVerifyModal(function (param) {
          return true;
        });
        return setVerifyDone(function (param) {
          return "Failure";
        });
      }
      throw e;
    }
  };
  React.useEffect(function () {
    getDetails();
  }, []);
  var getHeaderTextofPage = function () {
    switch (pageView) {
      case "SETUP_CREDS":
        return (
          "Setup " +
          ConnectorUtils.getDisplayNameForConnector(undefined, connectorName) +
          " credentials"
        );
      case "SETUP_WEBHOOK_PROCESSOR":
        return (
          "Setup Webhooks on " +
          ConnectorUtils.getDisplayNameForConnector(undefined, connectorName)
        );
      default:
        return "";
    }
  };
  var getSubTextOfPage = function () {
    switch (pageView) {
      case "SETUP_CREDS":
        return "Start by providing your live credentials";
      case "SETUP_WEBHOOK_PROCESSOR":
        return (
          "Enable relevant webhooks on your " +
          LogicUtils.capitalizeString(connectorName) +
          " account"
        );
      default:
        return "";
    }
  };
  var warningBlock =
    ProdOnboardingUtils.useGetWarningBlockForConnector(connectorVariant);
  var getComponentToRender = function () {
    switch (pageView) {
      case "SETUP_CREDS":
        return React.createElement(
          React.Fragment,
          {},
          React.createElement(RenderIf.make, {
            condition: Core__Option.isSome(warningBlock),
            children: React.createElement(
              ProdOnboardingUIUtils.WarningBlock.make,
              {
                customComponent: Caml_option.some(warningBlock),
              },
            ),
          }),
          React.createElement(SetupConnectorCredentials$ConnectorDetailsForm, {
            connectorName: connectorName,
            connectorDetails: connectorDetails,
            isCheckboxSelected: isCheckboxSelected,
            setIsCheckboxSelected: setIsCheckboxSelected,
            setVerifyDone: setVerifyDone,
            verifyErrorMessage: verifyErrorMessage,
            checkboxText: checkboxText,
          }),
        );
      case "SETUP_WEBHOOK_PROCESSOR":
        return React.createElement(
          ProdOnboardingUIUtils.SetupWebhookProcessor.make,
          {
            connectorName: connectorName,
            headerSectionText: "Hyperswitch Webhook Endpoint",
            subtextSectionText:
              "Configure this endpoint in the processors dashboard under webhook settings for us to receive events",
            customRightSection: React.createElement(
              HelperComponents.KeyAndCopyArea.make,
              {
                copyValue: ConnectorUtils.getWebhooksUrl(
                  connectorName,
                  merchantId,
                ),
                shadowClass: "shadow shadow-hyperswitch_box_shadow !w-full",
              },
            ),
          },
        );
      default:
        return React.createElement(React.Fragment, {});
    }
  };
  var onSubmit = function (values) {
    var dict = LogicUtils.getDictFromJsonObject(values);
    dict["profile_id"] = profile_id;
    ConnectorUtils.onSubmit(
      dict,
      onSubmitVerify,
      onSubmitMain,
      setVerifyDone,
      verifyDone,
      isVerifyConnector,
    );
  };
  var handleSubmit = function (values, param) {
    if (pageView === "SETUP_WEBHOOK_PROCESSOR") {
      onSubmit(values);
    } else {
      setPageView(function (param) {
        return ProdOnboardingUtils.getPageView(pageView);
      });
    }
    return Promise.resolve(null);
  };
  var buttonText;
  switch (verifyDone) {
    case "Failure":
      buttonText = "Try Again";
      break;
    case "NoAttempt":
      buttonText = "Connect and Proceed";
      break;
    case "Success":
    case "Loading":
      buttonText = "Loading...";
      break;
  }
  return React.createElement(PageLoaderWrapper.make, {
    children: Caml_option.some(
      React.createElement(
        Form.make,
        {
          children: null,
          onSubmit: handleSubmit,
          initialValues: match$5[0],
          validate: validateMandatoryField,
        },
        React.createElement(
          "div",
          {
            className: "flex flex-col h-full w-full ",
          },
          React.createElement(
            "div",
            {
              className: "flex justify-between px-11 py-8 flex-wrap gap-4",
            },
            React.createElement(
              "div",
              {
                className: "flex gap-4 items-center",
              },
              React.createElement(GatewayIcon.make, {
                gateway: connectorName.toUpperCase(),
                className: "w-8 h-8",
              }),
              React.createElement(
                "p",
                {
                  className: headerTextStyle,
                },
                ConnectorUtils.getDisplayNameForConnector(
                  undefined,
                  connectorName,
                ),
              ),
            ),
            React.createElement(
              "div",
              {
                className: "flex gap-4",
              },
              React.createElement(Button.make, {
                buttonState: isLoading ? "Disabled" : "Normal",
                text: "Back",
                buttonType: "PrimaryOutline",
                buttonSize: "Small",
                onClick: function (param) {
                  setPageView(function (param) {
                    return ProdOnboardingUtils.getBackPageView(pageView);
                  });
                },
                customButtonStyle: "!rounded-md",
              }),
              React.createElement(FormRenderer.SubmitButton.make, {
                text: buttonText,
                disabledParamter:
                  LogicUtils.isNonEmptyString(checkboxText) &&
                  !isCheckboxSelected,
                customSumbitButtonStyle: "!rounded-md",
                loadingText: isLoading ? "Loading ..." : "",
              }),
            ),
          ),
          React.createElement("div", {
            className: dividerColor,
          }),
          React.createElement(
            "div",
            {
              className: "flex flex-col gap-8 p-11 ",
            },
            React.createElement(
              "div",
              {
                className: "flex flex-col gap-2 ",
              },
              React.createElement(
                "p",
                {
                  className: headerTextStyle,
                },
                getHeaderTextofPage(),
              ),
              React.createElement(
                "p",
                {
                  className: subTextStyle,
                },
                getSubTextOfPage(),
              ),
            ),
            getComponentToRender(),
          ),
        ),
        React.createElement(
          ConnectorAccountDetailsHelper.VerifyConnectorModal.make,
          {
            showVerifyModal: match$6[0],
            setShowVerifyModal: setShowVerifyModal,
            connector: connectorName,
            verifyErrorMessage: verifyErrorMessage,
            suggestedActionExists: match$10[1],
            suggestedAction: match$10[0],
            setVerifyDone: setVerifyDone,
          },
        ),
        React.createElement(FormValuesSpy.make, {}),
      ),
    ),
    screenState: match[0],
  });
}

var make = SetupConnectorCredentials;

export {
  headerTextStyle,
  subTextStyle,
  dividerColor,
  ConnectorDetailsForm,
  make,
};
/* Form Not a pure module */
