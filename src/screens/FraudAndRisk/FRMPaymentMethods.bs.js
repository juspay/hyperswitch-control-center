// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Form from "../../utils/Form.bs.js";
import * as Icon from "../../components/Icon.bs.js";
import * as React from "react";
import * as FRMInfo from "./FRMInfo.bs.js";
import * as ToolTip from "../../components/tooltip/ToolTip.bs.js";
import * as FRMUtils from "./FRMUtils.bs.js";
import * as RenderIf from "../../utils/RenderIf.bs.js";
import * as Accordion from "../../components/Accordion.bs.js";
import * as RadioIcon from "../../components/custom-icons/RadioIcon.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as PopUpState from "../../hooks/PopUpState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as FormRenderer from "../../components/form/FormRenderer.bs.js";
import * as MixpanelHook from "../MixpanelHook.bs.js";
import * as FormValuesSpy from "../../components/form/FormValuesSpy.bs.js";
import * as ReactFinalForm from "react-final-form";
import * as React$1 from "@headlessui/react";
import * as ConnectorListHook from "../Hooks/ConnectorListHook.bs.js";
import * as PageLoaderWrapper from "../Helpers/PageLoaderWrapper.bs.js";
import * as JsxPPXReactSupportU from "rescript/lib/es6/jsxPPXReactSupportU.js";

function FRMPaymentMethods$RadioSection(props) {
  var setConfigJson = props.setConfigJson;
  var sectionType = props.sectionType;
  var paymentMethodTypeInfo = props.paymentMethodTypeInfo;
  var frmConfigs = props.frmConfigs;
  var option = props.option;
  var tmp;
  tmp =
    sectionType === "FlowType"
      ? paymentMethodTypeInfo.flow
      : paymentMethodTypeInfo.action;
  var isOptionSelected = tmp === option;
  var handleOnClick = function () {
    if (sectionType === "FlowType") {
      if (paymentMethodTypeInfo.flow !== option) {
        var match = FRMInfo.getFlowTypeVariantFromString(option);
        if (match === "PreAuth") {
          paymentMethodTypeInfo.action =
            FRMInfo.getActionTypeNameString("CancelTxn");
        } else {
          paymentMethodTypeInfo.action =
            FRMInfo.getActionTypeNameString("ManualReview");
        }
        paymentMethodTypeInfo.flow = option;
      }
    } else {
      paymentMethodTypeInfo.action = option;
    }
    setConfigJson(frmConfigs);
  };
  var tmp$1;
  tmp$1 =
    sectionType === "FlowType"
      ? FRMInfo.getFlowTypeLabel(option)
      : LogicUtils.snakeToTitle(FRMInfo.getActionTypeLabel(option));
  return React.createElement(
    "div",
    undefined,
    React.createElement(
      "div",
      {
        className: "flex items-center gap-2 break-all",
      },
      React.createElement(
        "div",
        {
          onClick: function (param) {
            handleOnClick();
          },
        },
        React.createElement(RadioIcon.make, {
          isSelected: isOptionSelected,
        }),
      ),
      tmp$1,
    ),
  );
}

var RadioSection = {
  make: FRMPaymentMethods$RadioSection,
};

function FRMPaymentMethods$ToggleSwitch(props) {
  var handleOnChange = props.handleOnChange;
  var isOpen = props.isOpen;
  var cursorType = props.isToggleDisabled
    ? "cursor-not-allowed"
    : "cursor-pointer";
  var enabledClasses = isOpen
    ? "bg-green-700 " + cursorType + " " + FRMUtils.toggleDefaultStyle
    : "bg-gray-300 " + cursorType + " " + FRMUtils.toggleDefaultStyle;
  var enabledSpanClasses = isOpen
    ? "translate-x-7 " + FRMUtils.accordionDefaultStyle
    : "translate-x-1 " + FRMUtils.accordionDefaultStyle;
  return React.createElement(React$1.Switch, {
    checked: isOpen,
    onChange: function (param) {
      handleOnChange();
    },
    className: enabledClasses,
    children: function (_checked) {
      return React.createElement(React.Fragment, {
        children: Caml_option.some(
          React.createElement("div", {
            "aria-hidden": true,
            className: enabledSpanClasses,
          }),
        ),
      });
    },
  });
}

var ToggleSwitch = {
  make: FRMPaymentMethods$ToggleSwitch,
};

function FRMPaymentMethods$FormField(props) {
  var setConfigJson = props.setConfigJson;
  var sectionType = props.sectionType;
  var frmConfigs = props.frmConfigs;
  var paymentMethodTypeInfo = props.paymentMethodTypeInfo;
  return React.createElement(
    "div",
    {
      className: "w-max",
    },
    React.createElement(
      "div",
      {
        className: "flex",
      },
      React.createElement(
        "h3",
        {
          className: "font-semibold text-bold text-lg pb-2",
        },
        LogicUtils.snakeToTitle(props.label),
      ),
      React.createElement(
        "div",
        {
          className: "w-10 h-7 text-gray-300",
        },
        React.createElement(ToolTip.make, {
          description: props.description,
          toolTipFor: Caml_option.some(
            React.createElement(Icon.make, {
              name: "info-circle",
              size: 15,
            }),
          ),
          tooltipWidthClass: "w-96",
          toolTipPosition: "Top",
        }),
      ),
    ),
    React.createElement(
      "div",
      {
        className: "grid grid-cols-2 md:grid-cols-4 gap-4",
      },
      React.createElement(RenderIf.make, {
        condition: sectionType === "ActionType",
        children: React.createElement(
          "div",
          {
            className: "flex items-center gap-2 break-all",
          },
          FRMInfo.getActionTypeLabel(paymentMethodTypeInfo.action),
        ),
      }),
      React.createElement(RenderIf.make, {
        condition: sectionType !== "ActionType",
        children: props.options.map(function (option, i) {
          return JsxPPXReactSupportU.createElementWithKey(
            i.toString(),
            FRMPaymentMethods$RadioSection,
            {
              option: option,
              frmConfigs: frmConfigs,
              paymentMethodTypeInfo: paymentMethodTypeInfo,
              sectionType: sectionType,
              setConfigJson: setConfigJson,
            },
          );
        }),
      }),
    ),
  );
}

var FormField = {
  make: FRMPaymentMethods$FormField,
};

function FRMPaymentMethods$CheckBoxRenderer(props) {
  var isUpdateFlow = props.isUpdateFlow;
  var connectorPaymentMethods = props.connectorPaymentMethods;
  var frmConfigs = props.frmConfigs;
  var frmConfigInfo = props.frmConfigInfo;
  var showPopUp = PopUpState.useShowPopUp();
  var frmConfigInput = ReactFinalForm.useField("frm_configs").input;
  var setConfigJson = frmConfigInput.onChange;
  var isToggleDisabled =
    connectorPaymentMethods !== undefined
      ? Object.keys(connectorPaymentMethods).length <= 0
      : true;
  var initToggleValue = isUpdateFlow
    ? frmConfigInfo.payment_methods.length > 0
    : !isToggleDisabled;
  var match = React.useState(function () {
    return initToggleValue;
  });
  var setIsOpen = match[1];
  var isOpen = match[0];
  var showConfitmation = function () {
    showPopUp({
      heading: "Heads up!",
      description:
        "Disabling the current toggle will result in the permanent deletion of all configurations associated with it",
      popUpType: ["Warning", "WithIcon"],
      handleCancel: {
        text: "No",
        onClick: function (param) {},
      },
      handleConfirm: {
        text: "Yes, disable it",
        onClick: function (param) {
          frmConfigInfo.payment_methods = [];
          setIsOpen(function (param) {
            return !isOpen;
          });
          setConfigJson(frmConfigs);
        },
      },
    });
  };
  var handleOnChange = function () {
    if (!isToggleDisabled) {
      if (isOpen) {
        if (frmConfigInfo.payment_methods.length > 0) {
          if (isUpdateFlow) {
            return showConfitmation();
          } else {
            frmConfigInfo.payment_methods = [];
            setConfigJson(frmConfigs);
            return setIsOpen(function (param) {
              return !isOpen;
            });
          }
        } else {
          return;
        }
      } else {
        if (connectorPaymentMethods !== undefined) {
          frmConfigInfo.payment_methods =
            FRMUtils.generateFRMPaymentMethodsConfig(connectorPaymentMethods);
          setConfigJson(frmConfigs);
        }
        return setIsOpen(function (param) {
          return !isOpen;
        });
      }
    }
  };
  React.useEffect(function () {
    if (isOpen && !isUpdateFlow && connectorPaymentMethods !== undefined) {
      frmConfigInfo.payment_methods = FRMUtils.generateFRMPaymentMethodsConfig(
        connectorPaymentMethods,
      );
      setConfigJson(frmConfigs);
    }
  }, []);
  return React.createElement(
    "div",
    undefined,
    React.createElement(
      "div",
      {
        className:
          "w-full px-5 py-3 bg-light-gray-bg flex items-center gap-3 justify-between border",
      },
      React.createElement(
        "div",
        {
          className: "font-semibold text-bold text-lg",
        },
        LogicUtils.snakeToTitle(frmConfigInfo.gateway),
      ),
      React.createElement(
        "div",
        {
          className: "mt-2",
        },
        isToggleDisabled
          ? React.createElement(ToolTip.make, {
              description: "No payment methods available",
              toolTipFor: Caml_option.some(
                React.createElement(FRMPaymentMethods$ToggleSwitch, {
                  isOpen: isOpen,
                  handleOnChange: handleOnChange,
                  isToggleDisabled: isToggleDisabled,
                }),
              ),
              toolTipPosition: "Top",
            })
          : React.createElement(FRMPaymentMethods$ToggleSwitch, {
              isOpen: isOpen,
              handleOnChange: handleOnChange,
              isToggleDisabled: isToggleDisabled,
            }),
      ),
    ),
    frmConfigInfo.payment_methods.map(function (paymentMethodInfo, index) {
      return JsxPPXReactSupportU.createElementWithKey(
        index.toString(),
        RenderIf.make,
        {
          condition: isOpen,
          children: paymentMethodInfo.payment_method_types.map(
            function (paymentMethodTypeInfo, i) {
              return JsxPPXReactSupportU.createElementWithKey(
                i.toString(),
                Accordion.make,
                {
                  accordion: [
                    {
                      title: LogicUtils.snakeToTitle(
                        paymentMethodTypeInfo.payment_method_type,
                      ),
                      renderContent: function () {
                        return React.createElement(
                          "div",
                          {
                            className: "grid grid-cols-1 lg:grid-cols-2 gap-5",
                          },
                          React.createElement(FRMPaymentMethods$FormField, {
                            options: FRMInfo.flowTypeAllOptions,
                            label: "Choose one of the flows",
                            paymentMethodTypeInfo: paymentMethodTypeInfo,
                            frmConfigs: frmConfigs,
                            sectionType: "FlowType",
                            setConfigJson: setConfigJson,
                            description:
                              'i. "PreAuth" - facilitate transaction verification prior to payment authorization.\n                        ii. "PostAuth" - facilitate transaction validation post-authorization, before amount capture.',
                          }),
                          React.createElement(FRMPaymentMethods$FormField, {
                            options: FRMInfo.getActionTypeAllOptions(
                              paymentMethodTypeInfo.flow,
                            ),
                            label: "Preferred Action",
                            paymentMethodTypeInfo: paymentMethodTypeInfo,
                            frmConfigs: frmConfigs,
                            sectionType: "ActionType",
                            setConfigJson: setConfigJson,
                            description: FRMInfo.actionDescriptionForFlow(
                              FRMInfo.getFlowTypeVariantFromString(
                                paymentMethodTypeInfo.flow,
                              ),
                            ),
                          }),
                        );
                      },
                      renderContentOnTop: undefined,
                    },
                  ],
                  accordianTopContainerCss: "border",
                  accordianBottomContainerCss: "p-5",
                  contentExpandCss: "px-10 pb-6 pt-3 !border-t-0",
                  initialExpandedArray: [0],
                  titleStyle: "font-semibold text-bold text-md",
                },
              );
            },
          ),
        },
      );
    }),
  );
}

var CheckBoxRenderer = {
  make: FRMPaymentMethods$CheckBoxRenderer,
};

function FRMPaymentMethods$PaymentMethodsRenderer(props) {
  var isUpdateFlow = props.isUpdateFlow;
  var match = React.useState(function () {
    return "Loading";
  });
  var setPageState = match[1];
  var frmConfigInput = ReactFinalForm.useField("frm_configs").input;
  var frmConfigs = FRMUtils.parseFRMConfig(frmConfigInput.value);
  var match$1 = React.useState(function () {
    return {};
  });
  var setConnectorConfig = match$1[1];
  var connectorConfig = match$1[0];
  var setConfigJson = frmConfigInput.onChange;
  var fetchConnectorListResponse = ConnectorListHook.useFetchConnectorList();
  var getConfiguredConnectorDetails = async function () {
    try {
      var response = await fetchConnectorListResponse();
      var connectorsConfig = FRMUtils.getConnectorConfig(
        FRMUtils.filterList(
          FRMUtils.filterList(
            LogicUtils.getArrayFromJson(response, []).map(
              LogicUtils.getDictFromJsonObject,
            ),
            "FRMPlayer",
            undefined,
          ),
          "ThreedsAuthenticator",
          undefined,
        ),
      );
      var updateFRMConfig = FRMUtils.createAllOptions(connectorsConfig).map(
        function (defaultConfig) {
          var config = frmConfigs.find(function (item) {
            return item.gateway === defaultConfig.gateway;
          });
          if (config !== undefined) {
            return config;
          } else {
            return defaultConfig;
          }
        },
      );
      setConnectorConfig(function (param) {
        return connectorsConfig;
      });
      setConfigJson(updateFRMConfig);
      return setPageState(function (param) {
        return "Success";
      });
    } catch (exn) {
      return setPageState(function (param) {
        return {
          TAG: "Error",
          _0: "Failed to fetch",
        };
      });
    }
  };
  React.useEffect(function () {
    getConfiguredConnectorDetails();
  }, []);
  return React.createElement(PageLoaderWrapper.make, {
    children: Caml_option.some(
      React.createElement(
        "div",
        {
          className: "flex flex-col gap-4",
        },
        frmConfigs.map(function (configInfo, i) {
          return JsxPPXReactSupportU.createElementWithKey(
            i.toString(),
            FRMPaymentMethods$CheckBoxRenderer,
            {
              frmConfigInfo: configInfo,
              frmConfigs: frmConfigs,
              connectorPaymentMethods: connectorConfig[configInfo.gateway],
              isUpdateFlow: isUpdateFlow,
            },
          );
        }),
      ),
    ),
    screenState: match[0],
  });
}

var PaymentMethodsRenderer = {
  make: FRMPaymentMethods$PaymentMethodsRenderer,
};

function FRMPaymentMethods(props) {
  var setInitialValues = props.setInitialValues;
  var __retrivedValues = props.retrivedValues;
  var setCurrentStep = props.setCurrentStep;
  var retrivedValues =
    __retrivedValues !== undefined
      ? Caml_option.valFromOption(__retrivedValues)
      : undefined;
  var mixpanelEvent = MixpanelHook.useSendEvent();
  var initialValues = Core__Option.getOr(retrivedValues, {});
  var onSubmit = function (values, param) {
    mixpanelEvent(
      "frm_step1",
      undefined,
      undefined,
      undefined,
      undefined,
      undefined,
    );
    var valuesDict = LogicUtils.getDictFromJsonObject(values);
    var filteredArray = FRMUtils.parseFRMConfig(
      LogicUtils.getJsonObjectFromDict(valuesDict, "frm_configs"),
    ).filter(function (config) {
      return config.payment_methods.length > 0;
    });
    valuesDict["frm_configs"] = filteredArray;
    setInitialValues(function (param) {
      return valuesDict;
    });
    setCurrentStep(function (prev) {
      return FRMInfo.getNextStep(prev);
    });
    return Promise.resolve(null);
  };
  var validate = function (_values) {
    return {};
  };
  return React.createElement(
    Form.make,
    {
      children: null,
      onSubmit: onSubmit,
      initialValues: initialValues,
      validate: validate,
    },
    React.createElement(
      "div",
      {
        className: "flex",
      },
      React.createElement(
        "div",
        {
          className: "flex flex-col w-full",
        },
        React.createElement(
          "div",
          {
            className: "w-full flex justify-end mb-5",
          },
          React.createElement(FormRenderer.SubmitButton.make, {
            text: "Proceed",
          }),
        ),
        React.createElement(
          "div",
          {
            className: "flex flex-col gap-2 col-span-3",
          },
          React.createElement(FRMPaymentMethods$PaymentMethodsRenderer, {
            isUpdateFlow: props.isUpdateFlow,
          }),
        ),
      ),
    ),
    React.createElement(FormValuesSpy.make, {}),
  );
}

var make = FRMPaymentMethods;

export {
  RadioSection,
  ToggleSwitch,
  FormField,
  CheckBoxRenderer,
  PaymentMethodsRenderer,
  make,
};
/* Form Not a pure module */
