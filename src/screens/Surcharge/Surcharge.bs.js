// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Form from "../../utils/Form.bs.js";
import * as React from "react";
import * as Button from "../../components/Button.bs.js";
import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as Recoil from "recoil";
import * as APIUtils from "../APIUtils/APIUtils.bs.js";
import * as RenderIf from "../../utils/RenderIf.bs.js";
import * as ACLButton from "../../components/ACLButton.bs.js";
import * as PageUtils from "../Helpers/PageUtils.bs.js";
import * as SelectBox from "../../components/SelectBox.bs.js";
import * as Core__JSON from "@rescript/core/src/Core__JSON.bs.js";
import * as GlobalVars from "../../utils/GlobalVars.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as PopUpState from "../../hooks/PopUpState.bs.js";
import * as ToastState from "../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as FormRenderer from "../../components/form/FormRenderer.bs.js";
import * as MixpanelHook from "../MixpanelHook.bs.js";
import * as FormValuesSpy from "../../components/form/FormValuesSpy.bs.js";
import * as RulePreviewer from "../RoutingRevamp/Previewers/RulePreviewer.bs.js";
import * as SurchargeUtils from "./SurchargeUtils.bs.js";
import * as AdvancedRouting from "../RoutingRevamp/AdvancedRouting.bs.js";
import * as HyperswitchAtom from "../../Recoils/HyperswitchAtom.bs.js";
import * as BasicDetailsForm from "../RoutingRevamp/BasicDetailsForm.bs.js";
import * as ReactFinalForm from "react-final-form";
import * as DragDropComponent from "../../components/DragDropComponent.bs.js";
import * as PageLoaderWrapper from "../Helpers/PageLoaderWrapper.bs.js";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as JsxPPXReactSupportU from "rescript/lib/es6/jsxPPXReactSupportU.js";
import * as RescriptReactRouter from "@rescript/react/src/RescriptReactRouter.bs.js";
import * as AdvancedRoutingUtils from "../RoutingRevamp/AdvancedRoutingUtils.bs.js";

function Surcharge$ActiveRulePreview(props) {
  var initialRule = props.initialRule;
  var rule = Core__Option.getOr(initialRule, {});
  var name = LogicUtils.getString(rule, "name", "");
  var description = LogicUtils.getString(rule, "description", "");
  var ruleInfo = SurchargeUtils.ruleInfoTypeMapper(
    LogicUtils.getDictfromDict(rule, "algorithm"),
  );
  return React.createElement(RenderIf.make, {
    condition: Core__Option.isSome(initialRule),
    children: React.createElement(
      "div",
      {
        className:
          "relative flex flex-col gap-6 w-full border p-6 bg-white rounded-md",
      },
      React.createElement(
        "div",
        {
          className:
            "absolute top-0 right-0 bg-green-700 text-white py-2 px-4 rounded-bl font-semibold",
        },
        "ACTIVE",
      ),
      React.createElement(
        "div",
        {
          className: "flex flex-col gap-2 ",
        },
        React.createElement(
          "p",
          {
            className: "text-xl font-semibold text-grey-700",
          },
          LogicUtils.capitalizeString(name),
        ),
        React.createElement(
          "p",
          {
            className: "text-base font-normal text-grey-700 opacity-50",
          },
          description,
        ),
      ),
      React.createElement(RulePreviewer.make, {
        ruleInfo: ruleInfo,
        isFromSurcharge: true,
      }),
    ),
  });
}

var ActiveRulePreview = {
  make: Surcharge$ActiveRulePreview,
};

function Surcharge$ConfigureSurchargeRule(props) {
  var wasm = props.wasm;
  var ruleInput = ReactFinalForm.useField("algorithm.rules").input;
  var match = React.useState(function () {
    return LogicUtils.getArrayFromJson(ruleInput.value, []);
  });
  var setRules = match[1];
  var rules = match[0];
  React.useEffect(
    function () {
      ruleInput.onChange(rules);
    },
    [rules],
  );
  var addRule = function (index, _copy) {
    var existingRules = LogicUtils.getArrayFromJson(ruleInput.value, []);
    var newRule = Core__Option.getOr(existingRules[index], null);
    var newRules = existingRules.concat([newRule]);
    ruleInput.onChange(newRules);
  };
  var notFirstRule =
    LogicUtils.getArrayFromJson(ruleInput.value, []).length > 1;
  var rule = Core__Option.getOr(Core__JSON.Decode.array(ruleInput.value), []);
  var keyExtractor = function (index, _rule, isDragging) {
    var id = "algorithm.rules[" + index.toString() + "]";
    return JsxPPXReactSupportU.createElementWithKey(
      index.toString(),
      AdvancedRouting.Wrapper.make,
      {
        id: id,
        heading: "Rule " + ((index + 1) | 0).toString(),
        onClickAdd: function (param) {
          addRule(index, false);
        },
        onClickCopy: function (param) {
          addRule(index, true);
        },
        onClickRemove: function (param) {
          var existingRules = LogicUtils.getArrayFromJson(ruleInput.value, []);
          var newRules = existingRules.filter(function (param, i) {
            return i !== index;
          });
          ruleInput.onChange(newRules);
        },
        gatewayOptions: SelectBox.makeOptions([]),
        notFirstRule: notFirstRule,
        isDragging: isDragging,
        wasm: wasm,
        isFromSurcharge: true,
      },
    );
  };
  return React.createElement(
    "div",
    undefined,
    notFirstRule
      ? React.createElement(DragDropComponent.make, {
          isHorizontal: false,
          listItems: rule,
          setListItems: function (v) {
            setRules(function (param) {
              return v;
            });
          },
          keyExtractor: keyExtractor,
        })
      : rule.map(function (rule, index) {
          return keyExtractor(index, rule, false);
        }),
  );
}

var ConfigureSurchargeRule = {
  make: Surcharge$ConfigureSurchargeRule,
};

function Surcharge(props) {
  var getURL = APIUtils.useGetURL();
  var showToast = ToastState.useShowToast();
  var fetchDetails = APIUtils.useGetMethod(false, undefined);
  var updateDetails = APIUtils.useUpdateMethod(false, undefined);
  var match = React.useState(function () {});
  var setWasm = match[1];
  var match$1 = React.useState(function () {
    return SurchargeUtils.buildInitialSurchargeValue;
  });
  var match$2 = React.useState(function () {});
  var setInitialRule = match$2[1];
  var match$3 = React.useState(function () {
    return "Loading";
  });
  var setScreenState = match$3[1];
  var match$4 = React.useState(function () {
    return "LANDING";
  });
  var setPageView = match$4[1];
  var showPopUp = PopUpState.useShowPopUp();
  var match$5 = React.useState(function () {
    return true;
  });
  var setShowWarning = match$5[1];
  var showWarning = match$5[0];
  var userPermissionJson = Recoil.useRecoilValue(
    HyperswitchAtom.userPermissionAtom,
  );
  var mixpanelEvent = MixpanelHook.useSendEvent();
  var getWasm = async function () {
    try {
      var wasmResult = await window.init();
      var wasm = LogicUtils.getObj(
        LogicUtils.getDictFromJsonObject(wasmResult),
        "wasm",
        {},
      );
      return setWasm(function (param) {
        return wasm;
      });
    } catch (exn) {
      return;
    }
  };
  var activeRoutingDetails = async function () {
    try {
      var surchargeUrl = getURL(
        "SURCHARGE",
        "Get",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var surchargeRuleDetail = await fetchDetails(surchargeUrl);
      var responseDict = LogicUtils.getDictFromJsonObject(surchargeRuleDetail);
      var programValue = LogicUtils.getObj(responseDict, "algorithm", {});
      var intitialValue = Object.fromEntries([
        ["name", LogicUtils.getString(responseDict, "name", "")],
        ["description", LogicUtils.getString(responseDict, "description", "")],
        ["algorithm", programValue],
      ]);
      return setInitialRule(function (param) {
        return intitialValue;
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        return Js_exn.raiseError(
          Core__Option.getOr(e._1.message, "Something went wrong"),
        );
      }
      throw e;
    }
  };
  var fetchDetails$1 = async function () {
    try {
      setScreenState(function (param) {
        return "Loading";
      });
      await getWasm();
      await activeRoutingDetails();
      return setScreenState(function (param) {
        return "Success";
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var err = Core__Option.getOr(e._1.message, "Something went wrong");
        if (err.includes("HE_02")) {
          setShowWarning(function (param) {
            return false;
          });
          setPageView(function (param) {
            return "LANDING";
          });
          return setScreenState(function (param) {
            return "Success";
          });
        } else {
          return setScreenState(function (param) {
            return {
              TAG: "Error",
              _0: err,
            };
          });
        }
      }
      throw e;
    }
  };
  React.useEffect(function () {
    fetchDetails$1();
  }, []);
  var onSubmit = async function (values, param) {
    try {
      mixpanelEvent(
        "surcharge_save",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var surchargePayload = SurchargeUtils.buildSurchargePayloadBody(values);
      var getActivateUrl = getURL(
        "SURCHARGE",
        "Put",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      await updateDetails(
        getActivateUrl,
        surchargePayload,
        "Put",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      fetchDetails$1();
      setShowWarning(function (param) {
        return true;
      });
      RescriptReactRouter.replace(GlobalVars.appendDashboardPath("/surcharge"));
      setPageView(function (param) {
        return "LANDING";
      });
      setScreenState(function (param) {
        return "Success";
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var err = Core__Option.getOr(e._1.message, "Failed to Fetch!");
        showToast(
          err,
          "ToastError",
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
        );
      } else {
        throw e;
      }
    }
    return null;
  };
  var validate = function (values) {
    var dict = LogicUtils.getDictFromJsonObject(values);
    var errors = {};
    AdvancedRoutingUtils.validateNameAndDescription(dict, errors);
    var jsonDict = Core__Option.flatMap(dict["algorithm"], function (obj) {
      return Core__JSON.Decode.object(obj);
    });
    if (jsonDict !== undefined) {
      var rules = LogicUtils.getArrayFromDict(jsonDict, "rules", []);
      if (rules.length === 0) {
        errors["Rules"] = "Minimum 1 rule needed";
      } else {
        rules.forEach(function (rule, i) {
          var ruleDict = LogicUtils.getDictFromJsonObject(rule);
          if (!SurchargeUtils.validateConditionsForSurcharge(ruleDict)) {
            errors["Rule " + ((i + 1) | 0).toString() + " - Condition"] =
              "Invalid";
            return;
          }
        });
      }
    }
    return errors;
  };
  var handleCreateNew = function () {
    mixpanelEvent(
      "create_new_surcharge",
      undefined,
      undefined,
      undefined,
      undefined,
      undefined,
    );
    if (showWarning) {
      return showPopUp({
        heading: "Heads up!",
        description:
          "This will override the existing surcharge configuration. Please confirm to proceed",
        popUpType: ["Warning", "WithIcon"],
        handleCancel: {
          text: "Cancel",
        },
        handleConfirm: {
          text: "Confirm",
          onClick: function (param) {
            setPageView(function (param) {
              return "NEW";
            });
          },
        },
      });
    } else {
      return setPageView(function (param) {
        return "NEW";
      });
    }
  };
  var tmp;
  tmp =
    match$4[0] === "NEW"
      ? React.createElement(
          "div",
          {
            className: "w-full border p-8 bg-white rounded-md ",
          },
          React.createElement(
            Form.make,
            {
              children: null,
              onSubmit: onSubmit,
              initialValues: match$1[0],
              validate: validate,
              formClass: "flex flex-col gap-6 justify-between",
            },
            React.createElement(BasicDetailsForm.make, {
              isThreeDs: true,
            }),
            React.createElement(Surcharge$ConfigureSurchargeRule, {
              wasm: match[0],
            }),
            React.createElement(FormValuesSpy.make, {}),
            React.createElement(
              "div",
              {
                className: "flex gap-4",
              },
              React.createElement(Button.make, {
                text: "Cancel",
                buttonType: "Secondary",
                onClick: function (param) {
                  setPageView(function (param) {
                    return "LANDING";
                  });
                  RescriptReactRouter.replace(
                    GlobalVars.appendDashboardPath("/surcharge"),
                  );
                },
              }),
              React.createElement(FormRenderer.SubmitButton.make, {
                text: "Save ",
                buttonType: "Primary",
                buttonSize: "Small",
              }),
            ),
          ),
        )
      : React.createElement(
          "div",
          {
            className: "flex flex-col gap-6",
          },
          React.createElement(Surcharge$ActiveRulePreview, {
            initialRule: match$2[0],
          }),
          React.createElement(
            "div",
            {
              className:
                "w-full border p-6 flex flex-col gap-6 bg-white rounded-md",
            },
            React.createElement(
              "p",
              {
                className: "text-base font-semibold text-grey-700",
              },
              "Configure Surcharge",
            ),
            React.createElement(
              "p",
              {
                className: "text-base font-normal text-grey-700 opacity-50",
              },
              "Create advanced rules using various payment parameters like amount, currency,payment method etc to enforce a surcharge on your payments",
            ),
            React.createElement(ACLButton.make, {
              text: "Create New",
              buttonType: "Primary",
              onClick: function (param) {
                handleCreateNew();
              },
              customButtonStyle: "!w-1/6 ",
              access: userPermissionJson.workflowsManage,
            }),
          ),
        );
  return React.createElement(PageLoaderWrapper.make, {
    children: Caml_option.some(
      React.createElement(
        "div",
        {
          className: "flex flex-col overflow-scroll gap-6",
        },
        React.createElement(PageUtils.PageHeading.make, {
          title: "Surcharge",
          subTitle: "Configure advanced rules to apply surcharges",
        }),
        tmp,
      ),
    ),
    screenState: match$3[0],
  });
}

var make = Surcharge;

export { ActiveRulePreview, ConfigureSurchargeRule, make };
/* Form Not a pure module */
