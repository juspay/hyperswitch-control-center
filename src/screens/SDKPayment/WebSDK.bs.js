// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Icon from "../../components/Icon.bs.js";
import * as React from "react";
import * as Button from "../../components/Button.bs.js";
import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as Loader from "../../components/Loader.bs.js";
import * as AuthHooks from "../../hooks/AuthHooks.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as Core__Promise from "@rescript/core/src/Core__Promise.bs.js";
import * as HyperSwitchUtils from "../../utils/HyperSwitchUtils.bs.js";
import * as PageLoaderWrapper from "../Helpers/PageLoaderWrapper.bs.js";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as ReactHyperJs from "@juspay-tech/react-hyper-js";

function WebSDK$CheckoutForm(props) {
  var setClientSecret = props.setClientSecret;
  var __isSpaceAccordion = props.isSpaceAccordion;
  var publishableKey = props.publishableKey;
  var __saveViewToSdk = props.saveViewToSdk;
  var returnUrl = props.returnUrl;
  var __methodsOrder = props.methodsOrder;
  var __layout = props.layout;
  var __fontSizeBase = props.fontSizeBase;
  var __fontFamily = props.fontFamily;
  var __bgColor = props.bgColor;
  var __primaryColor = props.primaryColor;
  var __theme = props.theme;
  var paymentElementOptions = props.paymentElementOptions;
  var setErrorMessage = props.setErrorMessage;
  var setPaymentStatus = props.setPaymentStatus;
  var clientSecret = props.clientSecret;
  var theme = __theme !== undefined ? __theme : "";
  var primaryColor = __primaryColor !== undefined ? __primaryColor : "";
  var bgColor = __bgColor !== undefined ? __bgColor : "";
  var fontFamily = __fontFamily !== undefined ? __fontFamily : "";
  var fontSizeBase = __fontSizeBase !== undefined ? __fontSizeBase : "";
  var layout = __layout !== undefined ? __layout : "";
  var methodsOrder = __methodsOrder !== undefined ? __methodsOrder : [];
  var saveViewToSdk = __saveViewToSdk !== undefined ? __saveViewToSdk : false;
  var isSpaceAccordion =
    __isSpaceAccordion !== undefined ? __isSpaceAccordion : false;
  var match = React.useState(function () {});
  var setError = match[1];
  var error = match[0];
  var match$1 = React.useState(function () {
    return "Normal";
  });
  var setBtnState = match$1[1];
  var hyper = ReactHyperJs.useHyper();
  var elements = ReactHyperJs.useWidgets();
  var match$2 = React.useState(function () {
    return null;
  });
  var setAppearanceElem = match$2[1];
  var appearanceElem = match$2[0];
  var match$3 = React.useState(function () {
    return null;
  });
  var setPaymentElem = match$3[1];
  var paymentElem = match$3[0];
  var fetchApi = AuthHooks.useApiFetcher();
  React.useEffect(
    function () {
      var val_config = Core__Option.getOr(
        JSON.stringify({
          appearanceElement: appearanceElem,
          paymentElement: paymentElem,
        }),
        "",
      );
      var val = {
        publishableKey: publishableKey,
        config: val_config,
      };
      setError(function (param) {});
      if (saveViewToSdk) {
        Core__Promise.$$catch(
          fetchApi(
            "https://4gla4dnvbg.execute-api.ap-south-1.amazonaws.com/default/hyperConfig",
            Core__Option.getOr(JSON.stringify(val), ""),
            undefined,
            Object.fromEntries([["Access-Control-Allow-Origin", "*"]]),
            "Post",
            undefined,
            undefined,
            undefined,
          )
            .then(function (res) {
              return res.json();
            })
            .then(function (json) {
              return Promise.resolve(json);
            }),
          function (_e) {
            return Promise.resolve({});
          },
        );
      }
    },
    [saveViewToSdk, clientSecret],
  );
  React.useEffect(
    function () {
      var appearanceVal = {
        appearance: {
          theme: theme,
          variables: {
            fontFamily: fontFamily,
            colorPrimary: primaryColor,
            fontSizeBase: fontSizeBase,
            colorBackground: bgColor,
          },
          rules: {
            ".Tab": {
              borderRadius: "0px",
              display: "flex",
              gap: "8px",
              height: "52px",
              flexDirection: "row",
              justifyContent: "center",
              borderRadius: "5px",
              alignItems: "center",
              fontSize: "100%",
            },
            ".Tab--selected": {
              display: "flex",
              gap: "8px",
              flexDirection: "row",
              justifyContent: "center",
              alignItems: "center",
              padding: "15px 32px",
              borderRadius: "5px",
              fontWeight: "700",
            },
            ".TabLabel": {
              overflowWrap: "break-word",
            },
            ".Tab--selected:hover": {
              display: "flex",
              gap: "8px",
              flexDirection: "row",
              justifyContent: "center",
              alignItems: "center",
              padding: "15px 32px",
              borderRadius: "5px",
              fontWeight: "700",
            },
            ".Tab:hover": {
              display: "flex",
              gap: "8px",
              flexDirection: "row",
              justifyContent: "center",
              alignItems: "center",
              padding: "15px 32px",
              borderRadius: "5px",
              fontWeight: "700",
            },
          },
        },
      };
      setAppearanceElem(function (param) {
        return appearanceVal;
      });
      elements.update(appearanceVal);
    },
    [elements, theme, primaryColor, bgColor, fontFamily, fontSizeBase],
  );
  React.useEffect(
    function () {
      var paymentElement = elements.getElement("payment");
      if (!(paymentElement == null)) {
        var paymentVal = {
          layout: {
            type: layout === "spaced Accordion" ? "accordion" : layout,
            defaultCollapsed:
              layout === "spaced Accordion" || layout === "accordion",
            radios: true,
            spacedAccordionItems: isSpaceAccordion,
          },
          paymentMethodOrder: methodsOrder,
        };
        setPaymentElem(function (param) {
          return paymentVal;
        });
        paymentElement.update(paymentVal);
      }
    },
    [layout, elements, methodsOrder],
  );
  var handleSubmit = async function () {
    try {
      var confirmParamsToPass = {
        elements: elements,
        confirmParams: LogicUtils.getJsonFromArrayOfJson([
          ["return_url", returnUrl],
        ]),
      };
      var res = await hyper.confirmPayment(confirmParamsToPass);
      var responseDict = LogicUtils.getDictFromJsonObject(res);
      var unifiedErrorMessage = LogicUtils.getString(
        responseDict,
        "unified_message",
        "",
      );
      var errorMessage = LogicUtils.getString(
        responseDict,
        "error_message",
        "",
      );
      var uiErrorMessage = LogicUtils.isNonEmptyString(unifiedErrorMessage)
        ? unifiedErrorMessage
        : errorMessage;
      setErrorMessage(function (param) {
        return uiErrorMessage;
      });
      var errorDict = LogicUtils.getDictfromDict(responseDict, "error");
      if (
        LogicUtils.getOptionString(errorDict, "type") !== "validation_error"
      ) {
        var status = LogicUtils.getOptionString(responseDict, "status");
        if (status !== undefined) {
          switch (status) {
            case "failed":
              setPaymentStatus(function (param) {
                return {
                  TAG: "FAILED",
                  _0: "Failed",
                };
              });
              break;
            case "succeeded":
              setPaymentStatus(function (param) {
                return "SUCCESS";
              });
              break;
            default:
              setPaymentStatus(function (param) {
                return "CUSTOMSTATE";
              });
          }
        } else {
          setPaymentStatus(function (param) {
            return "CUSTOMSTATE";
          });
        }
        setClientSecret(function (param) {});
      }
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var err = Core__Option.getOr(e._1.message, "Failed to Fetch!");
        var str = err.replace('"', "").replace('"', "");
        if (str === "Something went wrong") {
          setPaymentStatus(function (param) {
            return "CUSTOMSTATE";
          });
          setError(function (param) {});
        } else {
          setPaymentStatus(function (param) {
            return {
              TAG: "FAILED",
              _0: err,
            };
          });
          setError(function (param) {
            return err;
          });
        }
        setClientSecret(function (param) {});
      } else {
        throw e;
      }
    }
    return setBtnState(function (param) {
      return "Normal";
    });
  };
  React.useEffect(
    function () {
      hyper.retrievePaymentIntent(clientSecret).then(function (param) {
        return Promise.resolve();
      });
    },
    [hyper],
  );
  var tmp;
  var tmp$1 = props.paymentStatus;
  if (typeof tmp$1 !== "object") {
    switch (tmp$1) {
      case "INCOMPLETE":
        var tmp$2;
        tmp$2 =
          props.sdkType === "ELEMENT"
            ? React.createElement(ReactHyperJs.PaymentElement, {
                id: "payment-element",
                options: paymentElementOptions,
              })
            : React.createElement(ReactHyperJs.CardWidget, {
                id: "card-widget",
                options: paymentElementOptions,
              });
        tmp = React.createElement(
          "div",
          {
            className: "grid grid-row-2 gap-5",
          },
          React.createElement(
            "div",
            {
              className: "row-span-1 bg-white rounded-lg py-6 px-10 flex-1",
            },
            tmp$2,
            React.createElement(Button.make, {
              loadingText: "Please wait...",
              buttonState: match$1[0],
              text:
                "Pay " +
                props.currency +
                " " +
                (props.amount / 100.0).toString(),
              buttonType: "Primary",
              onClick: function (param) {
                setBtnState(function (param) {
                  return "Loading";
                });
                handleSubmit();
              },
              customButtonStyle: "p-1 mt-2 w-full rounded-md " + primaryColor,
            }),
          ),
          error !== undefined
            ? React.createElement(
                "div",
                {
                  className: "text-red-500",
                },
                Core__Option.getOr(JSON.stringify(error), "")
                  .replace('"', "")
                  .replace('"', ""),
              )
            : null,
        );
        break;
      case "LOADING":
        tmp = React.createElement(Loader.make, {});
        break;
      default:
        tmp = null;
    }
  } else {
    tmp = null;
  }
  return React.createElement("div", undefined, tmp);
}

var CheckoutForm = {
  make: WebSDK$CheckoutForm,
};

function WebSDK(props) {
  var __amount = props.amount;
  var __isSpaceAccordion = props.isSpaceAccordion;
  var __saveViewToSdk = props.saveViewToSdk;
  var __methodsOrder = props.methodsOrder;
  var __layout = props.layout;
  var __fontSizeBase = props.fontSizeBase;
  var __fontFamily = props.fontFamily;
  var __bgColor = props.bgColor;
  var __primaryColor = props.primaryColor;
  var __theme = props.theme;
  var publishableKey = props.publishableKey;
  var theme = __theme !== undefined ? __theme : "";
  var primaryColor = __primaryColor !== undefined ? __primaryColor : "";
  var bgColor = __bgColor !== undefined ? __bgColor : "";
  var fontFamily = __fontFamily !== undefined ? __fontFamily : "";
  var fontSizeBase = __fontSizeBase !== undefined ? __fontSizeBase : "";
  var layout = __layout !== undefined ? __layout : "";
  var methodsOrder = __methodsOrder !== undefined ? __methodsOrder : [];
  var saveViewToSdk = __saveViewToSdk !== undefined ? __saveViewToSdk : false;
  var isSpaceAccordion =
    __isSpaceAccordion !== undefined ? __isSpaceAccordion : false;
  var amount = __amount !== undefined ? __amount : 65400.0;
  var match = React.useState(function () {
    return "Loading";
  });
  var setScreenState = match[1];
  var loadDOM = async function () {
    try {
      var url = window._env_.sdkBaseUrl;
      if (url === undefined) {
        return setScreenState(function (param) {
          return {
            TAG: "Error",
            _0: "URL Not Configured",
          };
        });
      }
      var script = document.createElement("script");
      script.setAttribute("src", url);
      document.body.appendChild(script);
      await HyperSwitchUtils.delay(1000);
      return setScreenState(function (param) {
        return "Success";
      });
    } catch (exn) {
      return setScreenState(function (param) {
        return {
          TAG: "Error",
          _0: "",
        };
      });
    }
  };
  React.useEffect(function () {
    loadDOM();
  }, []);
  var hyperPromise = React.useCallback(
    async function () {
      return window.Hyper(publishableKey);
    },
    [publishableKey],
  );
  var match$1 = window.Hyper;
  return React.createElement(PageLoaderWrapper.make, {
    children: Caml_option.some(
      React.createElement(
        "div",
        undefined,
        match$1 !== undefined
          ? React.createElement(ReactHyperJs.Elements, {
              options: props.elementOptions,
              stripe: hyperPromise(),
              children: React.createElement(WebSDK$CheckoutForm, {
                clientSecret: props.clientSecret,
                sdkType: props.sdkType,
                paymentStatus: props.paymentStatus,
                currency: props.currency,
                setPaymentStatus: props.setPaymentStatus,
                setErrorMessage: props.setErrorMessage,
                paymentElementOptions: props.paymentElementOptions,
                theme: theme,
                primaryColor: primaryColor,
                bgColor: bgColor,
                fontFamily: fontFamily,
                fontSizeBase: fontSizeBase,
                layout: layout,
                methodsOrder: methodsOrder,
                returnUrl: props.returnUrl,
                saveViewToSdk: saveViewToSdk,
                publishableKey: publishableKey,
                isSpaceAccordion: isSpaceAccordion,
                amount: amount,
                setClientSecret: props.setClientSecret,
              }),
            })
          : null,
      ),
    ),
    screenState: match[0],
    sectionHeight: "!h-screen",
    customLoader: Caml_option.some(
      React.createElement(
        "div",
        {
          className: "mt-60 w-scrren flex flex-col justify-center items-center",
        },
        React.createElement(
          "div",
          {
            className: "animate-spin mb-1",
          },
          React.createElement(Icon.make, {
            name: "spinner",
            size: 20,
          }),
        ),
      ),
    ),
  });
}

var make = WebSDK;

export { CheckoutForm, make };
/* Icon Not a pure module */
