// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Icon from "../../../components/Icon.bs.js";
import * as Modal from "../../../utils/Modal.bs.js";
import * as React from "react";
import * as Button from "../../../components/Button.bs.js";
import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as Loader from "../../../components/Loader.bs.js";
import * as Recoil from "recoil";
import * as APIUtils from "../../APIUtils/APIUtils.bs.js";
import * as ACLButton from "../../../components/ACLButton.bs.js";
import * as Clipboard from "../../../libraries/Clipboard.bs.js";
import * as PageUtils from "../../Helpers/PageUtils.bs.js";
import * as EntityType from "../../../entities/EntityType.bs.js";
import * as LogicUtils from "../../../utils/LogicUtils.bs.js";
import * as PopUpState from "../../../hooks/PopUpState.bs.js";
import * as TableAtoms from "../../../Recoils/TableAtoms.bs.js";
import * as ToastState from "../../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as LoadedTable from "../../../components/LoadedTable.bs.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as FormRenderer from "../../../components/form/FormRenderer.bs.js";
import * as HSwitchUtils from "../../HSwitchUtils.bs.js";
import * as MixpanelHook from "../../MixpanelHook.bs.js";
import * as DownloadUtils from "../../../utils/DownloadUtils.bs.js";
import * as DeveloperUtils from "./DeveloperUtils.bs.js";
import * as ReactFinalForm from "../../../libraries/ReactFinalForm.bs.js";
import * as HyperswitchAtom from "../../../Recoils/HyperswitchAtom.bs.js";
import * as ReactFinalForm$1 from "react-final-form";
import * as PageLoaderWrapper from "../../Helpers/PageLoaderWrapper.bs.js";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as JsxPPXReactSupportU from "rescript/lib/es6/jsxPPXReactSupportU.js";
import * as LabelVisibilityContext from "../../../components/form/LabelVisibilityContext.bs.js";
import * as PublishableAndHashKeySection from "./PublishableAndHashKeySection.bs.js";

function KeyManagement$ApiEditModal(props) {
  var keyId = props.keyId;
  var __action = props.action;
  var showModal = props.showModal;
  var getAPIKeyDetails = props.getAPIKeyDetails;
  var setShowModal = props.setShowModal;
  var action = __action !== undefined ? __action : "Create";
  var getURL = APIUtils.useGetURL();
  var match = React.useState(function () {
    return "";
  });
  var setApiKey = match[1];
  var apiKey = match[0];
  var match$1 = React.useState(function () {
    return false;
  });
  var setShowCustomDate = match$1[1];
  var showCustomDate = match$1[0];
  var match$2 = React.useState(function () {
    return action;
  });
  var setModalState = match$2[1];
  var showToast = ToastState.useShowToast();
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var setShowCustomDate$1 = function (val) {
    setShowCustomDate(function (param) {
      return val;
    });
  };
  React.useEffect(
    function () {
      setShowCustomDate(function (param) {
        return false;
      });
      setModalState(function (param) {
        return action;
      });
    },
    [showModal],
  );
  var downloadKey = function (param) {
    DownloadUtils.downloadOld("apiKey.txt", apiKey);
  };
  var primaryBtnText;
  primaryBtnText = action === "Update" ? "Update" : "Create";
  var modalheader;
  modalheader = action === "Update" ? "Update API Key" : "Create API Key";
  var onSubmit = async function (values, param) {
    try {
      var valuesDict = LogicUtils.getDictFromJsonObject(values);
      var body = {};
      body["name"] = LogicUtils.getString(valuesDict, "name", "");
      var description = LogicUtils.getString(valuesDict, "description", "");
      body["description"] = description;
      var expirationDate = LogicUtils.getString(
        valuesDict,
        "expiration_date",
        "",
      );
      var match = DeveloperUtils.getRecordTypeFromString(
        LogicUtils.getString(valuesDict, "expiration", ""),
      );
      var expriryValue;
      expriryValue =
        match === "Never"
          ? DeveloperUtils.getStringFromRecordType("Never")
          : expirationDate;
      body["expiration"] = expriryValue;
      setModalState(function (param) {
        return "Loading";
      });
      var url;
      if (action === "Update") {
        var key_id = Core__Option.getOr(keyId, "");
        url = getURL(
          "API_KEYS",
          "Post",
          Caml_option.some(key_id),
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
        );
      } else {
        url = getURL(
          "API_KEYS",
          "Post",
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
        );
      }
      var json = await updateDetails(
        url,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var keyDict = LogicUtils.getDictFromJsonObject(json);
      setApiKey(function (param) {
        return LogicUtils.getString(keyDict, "api_key", "");
      });
      if (action === "Update") {
        setShowModal(function (param) {
          return false;
        });
      } else {
        Clipboard.writeText(LogicUtils.getString(keyDict, "api_key", ""));
        setModalState(function (param) {
          return "Success";
        });
      }
      getAPIKeyDetails();
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var _error = e._1.message;
        if (_error !== undefined) {
          showToast(
            "Api Key Generation Failed",
            "ToastError",
            undefined,
            undefined,
            undefined,
            undefined,
            undefined,
            undefined,
          );
        }
        setModalState(function (param) {
          return "SettingApiModalError";
        });
      } else {
        throw e;
      }
    }
    return null;
  };
  var tmp;
  var exit = 0;
  switch (match$2[0]) {
    case "Create":
    case "Update":
      exit = 1;
      break;
    case "Loading":
      tmp = React.createElement(Loader.make, {});
      break;
    case "SettingApiModalError":
      tmp = React.createElement(DeveloperUtils.ErrorUI.make, {
        text: primaryBtnText,
      });
      break;
    case "Success":
      tmp = React.createElement(DeveloperUtils.SuccessUI.make, {
        downloadFun: downloadKey,
        apiKey: apiKey,
      });
      break;
  }
  if (exit === 1) {
    tmp = JsxPPXReactSupportU.createElementWithKey(
      "API-key",
      ReactFinalForm$1.Form,
      {
        initialValues: props.initialValues,
        onSubmit: onSubmit,
        render: function (param) {
          return React.createElement(LabelVisibilityContext.make, {
            children: React.createElement(
              "form",
              {
                className: "flex flex-col gap-3 h-full w-full",
                onSubmit: param.handleSubmit,
              },
              React.createElement(
                FormRenderer.DesktopRow.make,
                {
                  children: null,
                },
                React.createElement(HSwitchUtils.TextFieldRow.make, {
                  label: DeveloperUtils.apiName.label,
                  children: React.createElement(
                    FormRenderer.FieldRenderer.make,
                    {
                      field: DeveloperUtils.apiName,
                      fieldWrapperClass: "w-96",
                      errorClass: HSwitchUtils.errorClass,
                    },
                  ),
                  isRequired: false,
                  labelWidth: "w-48",
                }),
                React.createElement(HSwitchUtils.TextFieldRow.make, {
                  label: DeveloperUtils.apiDescription.label,
                  children: React.createElement(
                    FormRenderer.FieldRenderer.make,
                    {
                      field: DeveloperUtils.apiDescription,
                      fieldWrapperClass: "w-96",
                      errorClass: HSwitchUtils.errorClass,
                    },
                  ),
                  isRequired: false,
                  labelWidth: "w-48",
                }),
                React.createElement(HSwitchUtils.TextFieldRow.make, {
                  label: DeveloperUtils.keyExpiry.label,
                  children: React.createElement(
                    FormRenderer.FieldRenderer.make,
                    {
                      field: DeveloperUtils.keyExpiry,
                      fieldWrapperClass: "w-96",
                      errorClass: HSwitchUtils.errorClass,
                    },
                  ),
                  isRequired: false,
                  labelWidth: "w-48",
                }),
                showCustomDate
                  ? React.createElement(HSwitchUtils.TextFieldRow.make, {
                      label: DeveloperUtils.keyExpiryCustomDate.label,
                      children: React.createElement(
                        FormRenderer.FieldRenderer.make,
                        {
                          field: DeveloperUtils.keyExpiryCustomDate,
                          fieldWrapperClass: "w-96",
                          errorClass: HSwitchUtils.errorClass,
                        },
                      ),
                      isRequired: false,
                      labelWidth: "w-48",
                    })
                  : null,
              ),
              React.createElement(FormRenderer.DesktopRow.make, {
                children: React.createElement(
                  "div",
                  {
                    className: "flex justify-end gap-5 mt-5 mb-1 -mr-2",
                  },
                  React.createElement(Button.make, {
                    text: "Cancel",
                    buttonType: "Secondary",
                    buttonSize: "Small",
                    onClick: function (param) {
                      setShowModal(function (param) {
                        return false;
                      });
                    },
                  }),
                  React.createElement(FormRenderer.SubmitButton.make, {
                    text: primaryBtnText,
                    buttonSize: "Small",
                  }),
                ),
              }),
            ),
            showLabel: false,
          });
        },
        subscription: ReactFinalForm.subscribeToPristine,
        validate: function (values) {
          return DeveloperUtils.validateAPIKeyForm(
            values,
            undefined,
            ["name", "expiration"],
            setShowCustomDate$1,
            undefined,
          );
        },
      },
    );
  }
  var modalBody = React.createElement("div", undefined, tmp);
  return React.createElement(Modal.make, {
    showModal: showModal,
    setShowModal: setShowModal,
    children: modalBody,
    modalHeading: modalheader,
    modalClass:
      "w-full max-w-2xl m-auto !bg-white dark:!bg-jp-gray-lightgray_background",
    closeOnOutsideClick: true,
  });
}

var ApiEditModal = {
  make: KeyManagement$ApiEditModal,
};

function KeyManagement$ApiKeyAddBtn(props) {
  var mixpanelEvent = MixpanelHook.useSendEvent();
  var userPermissionJson = Recoil.useRecoilValue(
    HyperswitchAtom.userPermissionAtom,
  );
  var match = React.useState(function () {
    return false;
  });
  var setShowModal = match[1];
  var initialValues = {};
  initialValues["expiration"] = DeveloperUtils.getStringFromRecordType("Never");
  return React.createElement(
    React.Fragment,
    {},
    React.createElement(KeyManagement$ApiEditModal, {
      setShowModal: setShowModal,
      getAPIKeyDetails: props.getAPIKeyDetails,
      initialValues: initialValues,
      showModal: match[0],
    }),
    React.createElement(ACLButton.make, {
      text: "Create New API Key",
      buttonType: "Secondary",
      buttonSize: "Small",
      leftIcon: {
        TAG: "CustomIcon",
        _0: React.createElement(Icon.make, {
          name: "plus",
          size: 12,
          className: "jp-gray-900 fill-opacity-50 dark:jp-gray-text_darktheme",
        }),
      },
      onClick: function (param) {
        mixpanelEvent(
          "create_new_api_key",
          undefined,
          undefined,
          undefined,
          undefined,
          undefined,
        );
        setShowModal(function (param) {
          return true;
        });
      },
      access: userPermissionJson.merchantDetailsManage,
    }),
  );
}

var ApiKeyAddBtn = {
  make: KeyManagement$ApiKeyAddBtn,
};

function KeyManagement$TableActionsCell(props) {
  var data = props.data;
  var getAPIKeyDetails = props.getAPIKeyDetails;
  var keyId = props.keyId;
  var getURL = APIUtils.useGetURL();
  var showToast = ToastState.useShowToast();
  var match = React.useState(function () {
    return false;
  });
  var setShowModal = match[1];
  var showPopUp = PopUpState.useShowPopUp();
  var deleteDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var deleteKey = async function () {
    try {
      var body = {};
      body["key_id"] = keyId;
      body["revoked"] = true;
      var deleteUrl = getURL(
        "API_KEYS",
        "Delete",
        Caml_option.some(keyId),
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      await deleteDetails(
        deleteUrl,
        body,
        "Delete",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      getAPIKeyDetails();
      return;
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var _error = e._1.message;
        if (_error !== undefined) {
          return showToast(
            "Failed to delete API key",
            "ToastError",
            undefined,
            undefined,
            undefined,
            undefined,
            undefined,
            undefined,
          );
        } else {
          return;
        }
      }
      throw e;
    }
  };
  var initialValues = Object.fromEntries([
    ["name", data.name],
    ["description", data.description],
  ]);
  if (data.expiration === "Never") {
    initialValues["expiration"] =
      DeveloperUtils.getStringFromRecordType("Never");
  } else {
    initialValues["expiration"] =
      DeveloperUtils.getStringFromRecordType("Custom");
    initialValues["expiration_date"] = data.expiration_date;
  }
  return React.createElement(
    "div",
    undefined,
    React.createElement(KeyManagement$ApiEditModal, {
      setShowModal: setShowModal,
      getAPIKeyDetails: getAPIKeyDetails,
      initialValues: initialValues,
      showModal: match[0],
      action: "Update",
      keyId: keyId,
    }),
    React.createElement(
      "div",
      {
        className: "invisible cursor-pointer group-hover:visible flex ",
      },
      React.createElement(
        "div",
        {
          onClick: function (param) {
            setShowModal(function (param) {
              return true;
            });
          },
        },
        React.createElement(Icon.make, {
          name: "edit",
          size: 14,
          className:
            "text-jp-gray-700 hover:text-jp-gray-900 dark:hover:text-white mr-4 mb-1",
        }),
      ),
      React.createElement(
        "div",
        {
          onClick: function (param) {
            showPopUp({
              heading: "Delete API Key",
              description: "Are you sure you want to DELETE the API Key?",
              popUpType: ["Warning", "WithIcon"],
              handleCancel: {
                text: "No, don't delete",
                onClick: function (param) {},
              },
              handleConfirm: {
                text: "Yes, delete it",
                onClick: function (param) {
                  deleteKey();
                },
              },
            });
          },
        },
        React.createElement(Icon.make, {
          name: "delete",
          size: 14,
          className:
            "text-jp-gray-700 hover:text-jp-gray-900 dark:hover:text-white mr-3 mb-1",
        }),
      ),
    ),
  );
}

var TableActionsCell = {
  make: KeyManagement$TableActionsCell,
};

function KeyManagement$ApiKeysTable(props) {
  var getURL = APIUtils.useGetURL();
  var fetchDetails = APIUtils.useGetMethod(undefined, undefined);
  var match = React.useState(function () {
    return 0;
  });
  var match$1 = React.useState(function () {
    return [];
  });
  var setData = match$1[1];
  var data = match$1[0];
  var match$2 = React.useState(function () {
    return "Loading";
  });
  var setScreenState = match$2[1];
  var getAPIKeyDetails = async function () {
    try {
      var apiKeyListUrl = getURL(
        "API_KEYS",
        "Get",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var apiKeys = await fetchDetails(apiKeyListUrl);
      setData(function (param) {
        return DeveloperUtils.getItems(apiKeys);
      });
      return setScreenState(function (param) {
        return "Success";
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var msg = e._1.message;
        if (msg !== undefined) {
          return setScreenState(function (param) {
            return {
              TAG: "Error",
              _0: msg,
            };
          });
        } else {
          return setScreenState(function (param) {
            return {
              TAG: "Error",
              _0: "Error",
            };
          });
        }
      }
      throw e;
    }
  };
  React.useEffect(function () {
    getAPIKeyDetails();
  }, []);
  var getCell = function (item, colType) {
    var appendString = function (str) {
      return str.concat("*".repeat(10));
    };
    switch (colType) {
      case "Name":
        return {
          TAG: "Text",
          _0: item.name,
        };
      case "Description":
        return {
          TAG: "Text",
          _0: item.description,
        };
      case "Prefix":
        return {
          TAG: "Text",
          _0: appendString(item.prefix),
        };
      case "Created":
        return {
          TAG: "Date",
          _0: item.created,
        };
      case "Expiration":
        if (item.expiration === "Never") {
          return {
            TAG: "Text",
            _0: LogicUtils.getFirstLetterCaps(
              item.expiration_date,
              undefined,
              undefined,
            ),
          };
        } else {
          return {
            TAG: "Date",
            _0: item.expiration_date,
          };
        }
      case "CustomCell":
        return {
          TAG: "CustomCell",
          _0: React.createElement(KeyManagement$TableActionsCell, {
            keyId: item.key_id,
            getAPIKeyDetails: getAPIKeyDetails,
            data: item,
          }),
          _1: "",
        };
    }
  };
  var visibleColumns = Recoil.useRecoilValue(TableAtoms.apiDefaultCols);
  var apiKeysTableEntity = EntityType.makeEntity(
    "",
    DeveloperUtils.getItems,
    DeveloperUtils.defaultColumns,
    DeveloperUtils.allColumns,
    DeveloperUtils.getHeading,
    getCell,
    "data",
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
    undefined,
  );
  return React.createElement(PageLoaderWrapper.make, {
    children: Caml_option.some(
      React.createElement(
        "div",
        {
          className: "relative mt-10 md:mt-0",
        },
        React.createElement(
          "h2",
          {
            className:
              "font-bold absolute top-0 md:top-10 left-0 text-xl pb-3 text-black text-opacity-75 dark:text-white dark:text-opacity-75",
          },
          "API Keys",
        ),
        React.createElement(LoadedTable.make, {
          visibleColumns: visibleColumns,
          title: " ",
          tableActions: Caml_option.some(
            React.createElement(
              "div",
              {
                className: "mt-5",
              },
              React.createElement(KeyManagement$ApiKeyAddBtn, {
                getAPIKeyDetails: getAPIKeyDetails,
              }),
            ),
          ),
          showSerialNumber: true,
          actualData: data.map(function (prim) {
            return prim;
          }),
          totalResults: data.length,
          resultsPerPage: 7,
          offset: match[0],
          setOffset: match[1],
          entity: apiKeysTableEntity,
          currrentFetchCount: data.length,
        }),
      ),
    ),
    screenState: match$2[0],
  });
}

var ApiKeysTable = {
  make: KeyManagement$ApiKeysTable,
};

function KeyManagement$KeysManagement(props) {
  return React.createElement(
    "div",
    undefined,
    React.createElement(PageUtils.PageHeading.make, {
      title: "Keys",
      subTitle:
        "Manage API keys and credentials for integrated payment services",
    }),
    React.createElement(KeyManagement$ApiKeysTable, {}),
    React.createElement(PublishableAndHashKeySection.make, {}),
  );
}

var KeysManagement = {
  make: KeyManagement$KeysManagement,
};

export {
  ApiEditModal,
  ApiKeyAddBtn,
  TableActionsCell,
  ApiKeysTable,
  KeysManagement,
};
/* Icon Not a pure module */
