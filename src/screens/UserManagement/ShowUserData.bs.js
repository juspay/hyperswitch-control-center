// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Icon from "../../components/Icon.bs.js";
import * as React from "react";
import * as Button from "../../components/Button.bs.js";
import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as Navbar from "../../components/Navbar.bs.js";
import * as Recoil from "recoil";
import * as APIUtils from "../APIUtils/APIUtils.bs.js";
import * as RenderIf from "../../utils/RenderIf.bs.js";
import * as PageUtils from "../Helpers/PageUtils.bs.js";
import * as GlobalVars from "../../utils/GlobalVars.bs.js";
import * as LogicUtils from "../../utils/LogicUtils.bs.js";
import * as PopUpState from "../../hooks/PopUpState.bs.js";
import * as ToastState from "../../hooks/ToastState.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Array from "@rescript/core/src/Core__Array.bs.js";
import * as InviteUsers from "./InviteUsers.bs.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as GlobalProvider from "../../entryPoints/Provider/GlobalProvider.bs.js";
import * as ProviderHelper from "../../entryPoints/Provider/ProviderHelper.bs.js";
import * as UserRoleEntity from "./UserRoleEntity.bs.js";
import * as CommonAuthHooks from "../../entryPoints/AuthModule/Common/CommonAuthHooks.bs.js";
import * as HyperswitchAtom from "../../Recoils/HyperswitchAtom.bs.js";
import * as React$1 from "@headlessui/react";
import * as PageLoaderWrapper from "../Helpers/PageLoaderWrapper.bs.js";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as DefaultLandingPage from "../Helpers/DefaultLandingPage.bs.js";
import * as JsxPPXReactSupportU from "rescript/lib/es6/jsxPPXReactSupportU.js";
import * as RescriptReactRouter from "@rescript/react/src/RescriptReactRouter.bs.js";
import * as UserManagementUtils from "./UserManagementUtils.bs.js";
import * as BreadCrumbNavigation from "../../utils/BreadCrumbNavigation.bs.js";
import * as HyperSwitchEntryUtils from "../../entryPoints/HyperSwitchEntryUtils.bs.js";

function ShowUserData$UserUtilsPopover(props) {
  var setIsUpdateRoleSelected = props.setIsUpdateRoleSelected;
  var infoValue = props.infoValue;
  var getURL = APIUtils.useGetURL();
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var showToast = ToastState.useShowToast();
  var match = Core__Option.getOr(
    CommonAuthHooks.useCommonAuthInfo(),
    CommonAuthHooks.defaultAuthInfo,
  );
  var showPopUp = PopUpState.useShowPopUp();
  var deleteUser = async function () {
    try {
      var url = getURL(
        "USERS",
        "Post",
        undefined,
        undefined,
        "USER_DELETE",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var body = LogicUtils.getJsonFromArrayOfJson([
        ["email", infoValue.email],
      ]);
      await updateDetails(
        url,
        body,
        "Delete",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      showToast(
        "User has been successfully deleted.",
        "ToastSuccess",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      return RescriptReactRouter.replace(
        GlobalVars.appendDashboardPath("/users"),
      );
    } catch (exn) {
      return;
    }
  };
  return React.createElement(RenderIf.make, {
    condition: infoValue.email !== match.email,
    children: React.createElement(React$1.Popover, {
      className: "relative inline-block text-left",
      children: function (popoverProps) {
        var openClasses = popoverProps.open
          ? "group border py-2 rounded-md inline-flex items-center text-base font-medium hover:text-opacity-100 focus:outline-none"
          : "text-opacity-90 group border py-2 rounded-md inline-flex items-center text-base font-medium hover:text-opacity-100 focus:outline-none";
        return React.createElement(
          React.Fragment,
          {},
          React.createElement(React$1.Popover.Button, {
            className: openClasses + " border-none",
            children: function (_buttonProps) {
              return React.createElement(Icon.make, {
                name: "menu-option",
                size: 28,
              });
            },
          }),
          React.createElement(React$1.Transition, {
            as: "span",
            enter: "transition ease-out duration-200",
            enterFrom: "opacity-0 translate-y-1",
            enterTo: "opacity-100 translate-y-0",
            leave: "transition ease-in duration-150",
            leaveFrom: "opacity-100 translate-y-0",
            leaveTo: "opacity-0 translate-y-1",
            children: Caml_option.some(
              React.createElement(React$1.Popover.Panel, {
                className: "absolute !z-30 right-2",
                children: function (panelProps) {
                  return React.createElement(
                    "div",
                    {
                      className:
                        "relative flex flex-col py-3 rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 w-40",
                    },
                    React.createElement(Navbar.MenuOption.make, {
                      text: "Update role",
                      onClick: function (param) {
                        panelProps.close();
                        setIsUpdateRoleSelected(function (param) {
                          return true;
                        });
                      },
                    }),
                    React.createElement(RenderIf.make, {
                      condition: infoValue.role_id !== "org_admin",
                      children: React.createElement(Navbar.MenuOption.make, {
                        text: "Delete user",
                        onClick: function (param) {
                          panelProps.close();
                          showPopUp({
                            heading:
                              "Are you sure you want to delete this user?",
                            description:
                              "This action cannot be undone. Deleting the user will permanently remove all associated data from this account. Press Confirm to delete.",
                            popUpType: ["Warning", "WithIcon"],
                            handleCancel: {
                              text: "Back",
                            },
                            handleConfirm: {
                              text: "Confirm",
                              onClick: function (param) {
                                deleteUser();
                              },
                            },
                          });
                        },
                      }),
                    }),
                  );
                },
              }),
            ),
          }),
        );
      },
    }),
  });
}

var UserUtilsPopover = {
  make: ShowUserData$UserUtilsPopover,
};

function ShowUserData$UserHeading(props) {
  var newRoleSelected = props.newRoleSelected;
  var setIsUpdateRoleSelected = props.setIsUpdateRoleSelected;
  var isUpdateRoleSelected = props.isUpdateRoleSelected;
  var infoValue = props.infoValue;
  var getURL = APIUtils.useGetURL();
  var fetchDetails = APIUtils.useGetMethod(undefined, undefined);
  var showToast = ToastState.useShowToast();
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var status = UserRoleEntity.statusToVariantMapper(infoValue.status);
  var match = React.useState(function () {
    return "Normal";
  });
  var setButtonState = match[1];
  var match$1 = React.useContext(GlobalProvider.defaultContext);
  var setPermissionInfo = match$1.setPermissionInfo;
  var permissionInfo = match$1.permissionInfo;
  var userPermissionJson = Recoil.useRecoilValue(
    HyperswitchAtom.userPermissionAtom,
  );
  var authId = HyperSwitchEntryUtils.getSessionData(
    "auth_id",
    undefined,
    undefined,
  );
  var resendInvite = async function () {
    try {
      setButtonState(function (param) {
        return "Loading";
      });
      var url = getURL(
        "USERS",
        "Post",
        undefined,
        undefined,
        "RESEND_INVITE",
        undefined,
        undefined,
        Caml_option.some("auth_id=" + authId),
        undefined,
      );
      var body = Object.fromEntries([["email", infoValue.email]]);
      await updateDetails(
        url,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      showToast(
        "Invite resend. Please check your email.",
        "ToastSuccess",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      return setButtonState(function (param) {
        return "Normal";
      });
    } catch (exn) {
      return setButtonState(function (param) {
        return "Normal";
      });
    }
  };
  var updatePermissionInfoOnBack = async function () {
    try {
      var url = getURL(
        "USER_MANAGEMENT",
        "Get",
        Caml_option.some(infoValue.role_id),
        undefined,
        undefined,
        "ROLE_ID",
        undefined,
        undefined,
        undefined,
      );
      var res = await fetchDetails(url);
      var defaultList =
        UserManagementUtils.defaultPresentInInfoList(permissionInfo);
      setPermissionInfo(function (param) {
        return defaultList;
      });
      var updatedPermissionListForGivenRole =
        UserManagementUtils.updatePresentInInfoList(
          defaultList,
          UserManagementUtils.getArrayOfPermissionData(res),
        );
      setPermissionInfo(function (param) {
        return updatedPermissionListForGivenRole;
      });
      return setIsUpdateRoleSelected(function (param) {
        return false;
      });
    } catch (exn) {
      return RescriptReactRouter.replace(
        GlobalVars.appendDashboardPath("/users"),
      );
    }
  };
  var updateRole = async function () {
    try {
      var url = getURL(
        "USERS",
        "Post",
        undefined,
        undefined,
        "UPDATE_ROLE",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var body = LogicUtils.getJsonFromArrayOfJson([
        ["email", infoValue.email],
        ["role_id", newRoleSelected],
      ]);
      await updateDetails(
        url,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      showToast(
        "Role successfully updated!",
        "ToastSuccess",
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
        undefined,
      );
      return RescriptReactRouter.replace(
        GlobalVars.appendDashboardPath("/users"),
      );
    } catch (exn) {
      return;
    }
  };
  var onClickHandler = function () {
    if (newRoleSelected === infoValue.role_id) {
      return setIsUpdateRoleSelected(function (param) {
        return false;
      });
    } else {
      updatePermissionInfoOnBack();
      return;
    }
  };
  var tmp;
  switch (status) {
    case "InviteSent":
      tmp = "INVITE SENT".toUpperCase();
      break;
    case "Active":
    case "None":
      tmp = infoValue.status.toUpperCase();
      break;
  }
  return React.createElement(
    "div",
    {
      className: "flex justify-between flex-wrap",
    },
    React.createElement(PageUtils.PageHeading.make, {
      title: infoValue.name,
      subTitle: infoValue.email,
      customTitleStyle: "!p-0",
      isTag: true,
      tagText: infoValue.role_name.toUpperCase(),
    }),
    React.createElement(RenderIf.make, {
      condition: isUpdateRoleSelected,
      children: React.createElement(
        "div",
        {
          className: "flex items-center gap-2",
        },
        React.createElement(Button.make, {
          text: "Back",
          buttonType: "Secondary",
          onClick: function (param) {
            onClickHandler();
          },
          customButtonStyle: "!p-3",
        }),
        React.createElement(Button.make, {
          text: "Update role",
          buttonType: "Primary",
          onClick: function (param) {
            updateRole();
          },
          customButtonStyle: "!p-3",
        }),
      ),
    }),
    React.createElement(RenderIf.make, {
      condition: !isUpdateRoleSelected,
      children: React.createElement(
        "div",
        {
          className: "flex items-center gap-4",
        },
        React.createElement(
          "div",
          {
            className: "font-semibold text-green-700",
          },
          tmp,
        ),
        React.createElement(RenderIf.make, {
          condition: userPermissionJson.usersManage === "Access",
          children: React.createElement(
            "div",
            {
              className: "flex items-center gap-2",
            },
            React.createElement(RenderIf.make, {
              condition: status !== "Active",
              children: React.createElement(Button.make, {
                buttonState: match[0],
                text: "Resend Invite",
                buttonType: "Primary",
                onClick: function (param) {
                  resendInvite();
                },
                customButtonStyle: "!px-2",
              }),
            }),
            React.createElement(ShowUserData$UserUtilsPopover, {
              infoValue: infoValue,
              setIsUpdateRoleSelected: setIsUpdateRoleSelected,
            }),
          ),
        }),
      ),
    }),
  );
}

var UserHeading = {
  make: ShowUserData$UserHeading,
};

function ShowUserData(props) {
  var getURL = APIUtils.useGetURL();
  var fetchDetails = APIUtils.useGetMethod(undefined, undefined);
  var url = RescriptReactRouter.useUrl(undefined, undefined);
  var match = React.useState(function () {
    return null;
  });
  var setRoleData = match[1];
  var roleData = match[0];
  var match$1 = React.useContext(GlobalProvider.defaultContext);
  var setPermissionInfo = match$1.setPermissionInfo;
  var permissionInfo = match$1.permissionInfo;
  var match$2 = React.useState(function () {
    return "Loading";
  });
  var setScreenState = match$2[1];
  var match$3 = React.useState(function () {
    return false;
  });
  var isUpdateRoleSelected = match$3[0];
  var match$4 = React.useState(function () {
    return "";
  });
  var match$5 = React.useState(function () {
    return UserRoleEntity.itemToObjMapperForUser({});
  });
  var setCurrentSelectedUser = match$5[1];
  var currentSelectedUser = match$5[0];
  var getRoleForUser = async function (role_id) {
    try {
      var url = getURL(
        "USER_MANAGEMENT",
        "Get",
        Caml_option.some(role_id),
        undefined,
        undefined,
        "ROLE_ID",
        undefined,
        undefined,
        undefined,
      );
      var res = await fetchDetails(url + "?groups=true");
      setRoleData(function (param) {
        return res;
      });
      return setScreenState(function (param) {
        return "Success";
      });
    } catch (raw_e) {
      var e = Caml_js_exceptions.internalToOCamlException(raw_e);
      if (e.RE_EXN_ID === Js_exn.$$Error) {
        var err = Core__Option.getOr(e._1.message, "Failed to Fetch!");
        return setScreenState(function (param) {
          return {
            TAG: "Error",
            _0: err,
          };
        });
      }
      throw e;
    }
  };
  var getPermissionInfo = async function () {
    try {
      var url = getURL(
        "USERS",
        "Get",
        undefined,
        undefined,
        "PERMISSION_INFO",
        undefined,
        undefined,
        "groups=true",
        undefined,
      );
      var res = await fetchDetails(url);
      var permissionInfoValue = LogicUtils.getArrayDataFromJson(
        res,
        ProviderHelper.itemToObjMapperForGetInfo,
      );
      return setPermissionInfo(function (param) {
        return permissionInfoValue;
      });
    } catch (exn) {
      return;
    }
  };
  var getUserData = async function () {
    try {
      var userDataURL = getURL(
        "USER_MANAGEMENT",
        "Get",
        undefined,
        undefined,
        undefined,
        "USER_LIST",
        undefined,
        undefined,
        undefined,
      );
      var res = await fetchDetails(userDataURL);
      var userData = LogicUtils.getArrayDataFromJson(
        res,
        UserRoleEntity.itemToObjMapperForUser,
      );
      var localCurrentSelectedUser = Core__Array.reduce(
        userData.map(function (prim) {
          return prim;
        }),
        UserRoleEntity.itemToObjMapperForUser({}),
        function (acc, ele) {
          if (
            Core__Option.getOr(
              LogicUtils.getDictFromUrlSearchParams(url.search)["email"],
              "",
            ).includes(ele.email)
          ) {
            return ele;
          } else {
            return acc;
          }
        },
      );
      setCurrentSelectedUser(function (param) {
        return localCurrentSelectedUser;
      });
      if (LogicUtils.isNonEmptyString(localCurrentSelectedUser.role_id)) {
        getRoleForUser(localCurrentSelectedUser.role_id);
        return;
      } else {
        return setScreenState(function (param) {
          return "Custom";
        });
      }
    } catch (exn) {
      return;
    }
  };
  React.useEffect(function () {
    getUserData();
    if (permissionInfo.length === 0) {
      getPermissionInfo();
    }
  }, []);
  React.useEffect(
    function () {
      var defaultList =
        UserManagementUtils.defaultPresentInInfoList(permissionInfo);
      setPermissionInfo(function (param) {
        return defaultList;
      });
      var updatedPermissionListForGivenRole =
        UserManagementUtils.updatePresentInInfoList(
          defaultList,
          UserManagementUtils.getArrayOfPermissionData(roleData),
        );
      setPermissionInfo(function (param) {
        return updatedPermissionListForGivenRole;
      });
    },
    [roleData],
  );
  var customUrlErrorScreen = React.createElement(DefaultLandingPage.make, {
    title: "Oops, we hit a little bump on the road!",
    subtitle:
      "We apologize for the inconvenience, but it seems like we encountered a hiccup while processing your request.",
    customStyle: "py-16 !m-0 h-80-vh",
    isButton: true,
    buttonText: "Back",
    onClickHandler: function () {
      RescriptReactRouter.replace(GlobalVars.appendDashboardPath("/users"));
    },
    overriddingStylesTitle: "text-2xl font-semibold",
    overriddingStylesSubtitle: "!text-sm text-grey-700 opacity-50 !w-3/4",
  });
  return React.createElement(PageLoaderWrapper.make, {
    children: Caml_option.some(
      React.createElement(
        "div",
        {
          className: "h-full",
        },
        React.createElement(BreadCrumbNavigation.make, {
          path: [
            {
              title: "Users",
              link: "/users",
            },
          ],
          currentPageTitle: currentSelectedUser.name,
        }),
        React.createElement(
          "div",
          {
            className: "h-4/5 bg-white mt-5 p-10 relative flex flex-col gap-8",
          },
          React.createElement(ShowUserData$UserHeading, {
            infoValue: currentSelectedUser,
            isUpdateRoleSelected: isUpdateRoleSelected,
            setIsUpdateRoleSelected: match$3[1],
            newRoleSelected: match$4[0],
          }),
          React.createElement(RenderIf.make, {
            condition: !isUpdateRoleSelected,
            children: React.createElement(
              "div",
              {
                className:
                  "flex flex-col justify-between gap-12 show-scrollbar overflow-scroll",
              },
              permissionInfo.map(function (ele, index) {
                return JsxPPXReactSupportU.createElementWithKey(
                  String(index),
                  UserManagementUtils.RolePermissionValueRenderer.make,
                  {
                    heading: LogicUtils.snakeToTitle(ele.module_) + " module",
                    description: ele.description,
                    isPermissionAllowed: ele.isPermissionAllowed,
                  },
                );
              }),
            ),
          }),
          React.createElement(RenderIf.make, {
            condition: isUpdateRoleSelected,
            children: React.createElement(InviteUsers.make, {
              isInviteUserFlow: false,
              setNewRoleSelected: match$4[1],
              currentRole: currentSelectedUser.role_id,
            }),
          }),
        ),
      ),
    ),
    screenState: match$2[0],
    customUI: Caml_option.some(customUrlErrorScreen),
  });
}

var make = ShowUserData;

export { UserUtilsPopover, UserHeading, make };
/* Icon Not a pure module */
