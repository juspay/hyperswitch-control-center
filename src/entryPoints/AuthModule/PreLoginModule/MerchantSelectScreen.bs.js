// Generated by ReScript, PLEASE EDIT WITH CARE

import * as React from "react";
import * as APIUtils from "../../../screens/APIUtils/APIUtils.bs.js";
import * as AuthUtils from "../AuthUtils.bs.js";
import * as Core__JSON from "@rescript/core/src/Core__JSON.bs.js";
import * as LogicUtils from "../../../utils/LogicUtils.bs.js";
import * as Core__Array from "@rescript/core/src/Core__Array.bs.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as AuthInfoProvider from "../../../context/AuthInfoProvider.bs.js";
import * as CommonInviteScreen from "../Common/CommonInviteScreen.bs.js";

function MerchantSelectScreen(props) {
  var getURL = APIUtils.useGetURL();
  var match = React.useContext(AuthInfoProvider.authStatusContext);
  var setAuthStatus = match.setAuthStatus;
  var fetchDetails = APIUtils.useGetMethod(undefined, undefined);
  var updateDetails = APIUtils.useUpdateMethod(undefined, undefined);
  var match$1 = React.useState(function () {
    return [];
  });
  var setMerchantData = match$1[1];
  var merchantData = match$1[0];
  var getListOfMerchantIds = async function () {
    try {
      var url = getURL(
        "USERS",
        "Get",
        undefined,
        undefined,
        "MERCHANTS_SELECT",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var listOfMerchants = await fetchDetails(url);
      return setMerchantData(function (param) {
        return LogicUtils.getArrayFromJson(listOfMerchants, []);
      });
    } catch (exn) {
      return setAuthStatus("LoggedOut");
    }
  };
  React.useEffect(function () {
    getListOfMerchantIds();
  }, []);
  var onClickLoginToDashboard = async function () {
    try {
      var url = getURL(
        "USERS",
        "Post",
        undefined,
        undefined,
        "ACCEPT_INVITE_TOKEN_ONLY",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      var acceptedMerchantIds = Core__Array.reduce(
        merchantData,
        [],
        function (acc, ele) {
          var merchantDataDict = LogicUtils.getDictFromJsonObject(ele);
          if (LogicUtils.getBool(merchantDataDict, "is_active", false)) {
            acc.push(LogicUtils.getString(merchantDataDict, "merchant_id", ""));
          }
          return acc;
        },
      );
      var body = LogicUtils.getJsonFromArrayOfJson([
        ["merchant_ids", acceptedMerchantIds],
      ]);
      var res = await updateDetails(
        url,
        body,
        "Post",
        undefined,
        undefined,
        undefined,
        undefined,
      );
      return setAuthStatus({
        TAG: "PreLogin",
        _0: AuthUtils.getPreLoginInfo(undefined, res),
      });
    } catch (exn) {
      return;
    }
  };
  var acceptInviteUpdate = function (index) {
    var merchantDataUpdated = Core__Option.getOr(
      Core__JSON.Decode.array(
        LogicUtils.safeParse(
          Core__Option.getOr(JSON.stringify(merchantData), ""),
        ),
      ),
      [],
    );
    LogicUtils.getDictFromJsonObject(
      LogicUtils.getValueFromArray(merchantDataUpdated, index, null),
    )["is_active"] = true;
    setMerchantData(function (param) {
      return merchantDataUpdated;
    });
  };
  return React.createElement(CommonInviteScreen.make, {
    merchantData: merchantData,
    acceptInviteOnClick: acceptInviteUpdate,
    onClickLoginToDashboard: onClickLoginToDashboard,
  });
}

var make = MerchantSelectScreen;

export { make };
/* react Not a pure module */
