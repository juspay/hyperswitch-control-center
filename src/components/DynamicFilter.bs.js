// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Icon from "./Icon.bs.js";
import * as Modal from "../utils/Modal.bs.js";
import * as React from "react";
import * as Button from "./Button.bs.js";
import * as Filter from "./Filter.bs.js";
import * as Recoil from "recoil";
import * as LogicUtils from "../utils/LogicUtils.bs.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Option from "@rescript/core/src/Core__Option.bs.js";
import * as FilterContext from "../context/FilterContext.bs.js";
import * as ThemeProvider from "../context/ThemeProvider.bs.js";
import * as AnalyticsAtoms from "../screens/Analytics/AnalyticsAtoms.bs.js";
import React$1 from "@monaco-editor/react";

function DynamicFilter$CustomFilters(props) {
  var currentFilterValue = props.currentFilterValue;
  var setCustomFilter = props.setCustomFilter;
  var tabNames = props.tabNames;
  var setShowModal = props.setShowModal;
  var match = React.useState(function () {
    return "";
  });
  var setErrMessage = match[1];
  var errMessage = match[0];
  var match$1 = Recoil.useRecoilState(AnalyticsAtoms.completionProvider);
  var setCompletionDisposable = match$1[1];
  var completionDisposable = match$1[0];
  var match$2 = ThemeProvider.useTheme();
  var theme;
  theme = match$2 === "Light" ? "light" : "vs-dark";
  var match$3 = React.useState(function () {
    return currentFilterValue;
  });
  var setLocalData = match$3[1];
  var localData = match$3[0];
  var placeholderText =
    "ex: payment_method_type = 'UPI' and payment_method_type in ('WALLET', 'UPI') or currency not in ('GBP', 'AED') and auth_type != 'OTP'";
  var match$4 = React.useState(function () {
    return placeholderText;
  });
  var setPlaceHolder = match$4[1];
  var placeholderTextSt = match$4[0];
  var onSubmit = function (param) {
    setCustomFilter(localData);
    setShowModal(function (param) {
      return false;
    });
  };
  var onChange = function (str) {
    if (LogicUtils.isEmptyString(str)) {
      setPlaceHolder(function (param) {
        return placeholderText;
      });
    }
    setLocalData(function (param) {
      return str;
    });
  };
  React.useEffect(
    function () {
      setErrMessage(function (param) {
        return "";
      });
      if (localData.includes('"')) {
        setErrMessage(function (str) {
          return str + " Please use ' instead of \".";
        });
      }
      var validatorArr = localData
        .replace(/ AND /gi, "@@")
        .replace(/ OR /gi, "@@")
        .split("@@");
      validatorArr.forEach(function (ele) {
        var mArr = ele
          .replace(/ != /gi, "@@")
          .replace(/ > /gi, "@@")
          .replace(/ < /gi, "@@")
          .replace(/ >= /gi, "@@")
          .replace(/ <= /gi, "@@")
          .replace(/ = /gi, "@@")
          .replace(/ IN /gi, "@@")
          .replace(/ NOT IN /gi, "@@")
          .replace(/ LIKE /gi, "@@")
          .split("@@");
        var firstEle = Core__Option.getOr(mArr[0], "");
        if (
          LogicUtils.isNonEmptyString(firstEle) &&
          tabNames.indexOf(firstEle.trim().toLowerCase()) < 0
        ) {
          return setErrMessage(function (str) {
            return str + " " + firstEle + " is not a valid dimension.";
          });
        }
      });
    },
    [localData],
  );
  var beforeMount = function (monaco) {
    var provideCompletionItems = function (model, position) {
      var word = model.getWordUntilPosition(position);
      var range_startLineNumber = position.lineNumber;
      var range_endLineNumber = position.lineNumber;
      var range_startColumn = word.startColumn;
      var range_endColumn = word.endColumn;
      var range = {
        startLineNumber: range_startLineNumber,
        endLineNumber: range_endLineNumber,
        startColumn: range_startColumn,
        endColumn: range_endColumn,
      };
      var createSuggest = function (range) {
        return tabNames.map(function (val) {
          return {
            label: val,
            insertText: val,
            range: range,
          };
        });
      };
      return {
        suggestions: createSuggest(range),
      };
    };
    if (completionDisposable !== undefined) {
      return;
    } else {
      return setCompletionDisposable(function (param) {
        return Caml_option.some(
          monaco.languages.registerCompletionItemProvider("sql", {
            provideCompletionItems: provideCompletionItems,
          }),
        );
      });
    }
  };
  var match$5 = React.useState(function () {
    return false;
  });
  var setMouseEnter = match$5[1];
  return React.createElement(
    "div",
    {
      className: "border-t border-gray-200 p-5",
      onKeyPress: function (param) {
        setMouseEnter(function (param) {
          return true;
        });
      },
      onClick: function (param) {
        setPlaceHolder(function (param) {
          return "";
        });
      },
      onMouseLeave: function (param) {
        setMouseEnter(function (param) {
          return false;
        });
      },
    },
    LogicUtils.isNonEmptyString(placeholderTextSt) &&
      LogicUtils.isEmptyString(localData) &&
      !match$5[0]
      ? React.createElement(
          "div",
          {
            className: "monaco-placeholder text-black opacity-50 ml-6 ",
          },
          placeholderTextSt,
        )
      : null,
    React.createElement(React$1, {
      height: "40vh",
      theme: theme,
      language: "sql",
      onChange: onChange,
      value: localData,
      beforeMount: beforeMount,
      options: {
        emptySelectionClipboard: true,
        wordWrap: "on",
        lineNumbers: "off",
        minimap: {
          enabled: false,
        },
        roundedSelection: false,
      },
    }),
    React.createElement(
      "div",
      undefined,
      React.createElement(
        "span",
        {
          className: "flex break-words text-red-800",
        },
        LogicUtils.isEmptyString(errMessage) ? null : errMessage,
      ),
      React.createElement(
        "div",
        {
          className: "mt-6",
        },
        React.createElement(Button.make, {
          buttonState: LogicUtils.isEmptyString(errMessage)
            ? "Normal"
            : "Disabled",
          text: "Apply Filter",
          buttonType: "Primary",
          buttonSize: "Small",
          onClick: onSubmit,
        }),
      ),
    ),
  );
}

var CustomFilters = {
  make: DynamicFilter$CustomFilters,
};

function DynamicFilter(props) {
  var __showSelectFiltersSearch = props.showSelectFiltersSearch;
  var __customFilterKey = props.customFilterKey;
  var __moduleName = props.moduleName;
  var __filterButtonStyle = props.filterButtonStyle;
  var __customLeftView = props.customLeftView;
  var tabNames = props.tabNames;
  var initialFilters = props.initialFilters;
  var customLeftView =
    __customLeftView !== undefined
      ? Caml_option.valFromOption(__customLeftView)
      : null;
  var filterButtonStyle =
    __filterButtonStyle !== undefined ? __filterButtonStyle : "";
  var moduleName = __moduleName !== undefined ? __moduleName : "";
  var customFilterKey =
    __customFilterKey !== undefined ? __customFilterKey : "";
  var showSelectFiltersSearch =
    __showSelectFiltersSearch !== undefined ? __showSelectFiltersSearch : false;
  var match = React.useContext(ThemeProvider.themeContext);
  var localFilters = initialFilters.filter(function (item) {
    return Core__Option.isSome(item.localFilter);
  });
  var remoteOptions = props.options.filter(function (item) {
    return Core__Option.isNone(item.localFilter);
  });
  var match$1 = React.useState(function () {
    return false;
  });
  var setShowModal = match$1[1];
  var match$2 = React.useContext(FilterContext.filterContext);
  var removeKeys = match$2.removeKeys;
  var updateExistingKeys = match$2.updateExistingKeys;
  var currentCustomFilterValue = Core__Option.getOr(
    match$2.filterValue[customFilterKey],
    "",
  );
  var setCustomFilter = function (customFilter) {
    updateExistingKeys(Object.fromEntries([[customFilterKey, customFilter]]));
  };
  var customFilters = LogicUtils.isNonEmptyString(customFilterKey)
    ? React.createElement(
        React.Fragment,
        {},
        React.createElement(
          "div",
          {
            className: "mx-2",
          },
          React.createElement(Button.make, {
            text: "Add Custom Filters",
            buttonType: "FilterAdd",
            buttonSize: "Small",
            leftIcon: {
              TAG: "CustomIcon",
              _0: React.createElement(Icon.make, {
                name: "add_custom_img",
                size: 14,
              }),
            },
            showBorder: false,
            onClick: function (_ev) {
              setShowModal(function (param) {
                return true;
              });
            },
            textStyle: match.globalUIConfig.font.textColor.primaryNormal,
          }),
        ),
        React.createElement(Modal.make, {
          showModal: match$1[0],
          setShowModal: setShowModal,
          children: React.createElement(DynamicFilter$CustomFilters, {
            setShowModal: setShowModal,
            tabNames: tabNames,
            moduleName: moduleName,
            setCustomFilter: setCustomFilter,
            currentFilterValue: currentCustomFilterValue,
          }),
          modalHeading: "Add Custom Filter",
          modalClass: "w-full md:w-2/3 mx-auto",
        }),
      )
    : null;
  var clearFilters = function () {
    var clearFilterKeys = [customFilterKey].concat(tabNames);
    removeKeys(clearFilterKeys);
  };
  return React.createElement(
    "div",
    {
      className: "flex-1 ml-1",
    },
    React.createElement(Filter.make, {
      defaultFilters: "",
      fixedFilters: props.initialFixedFilters,
      requiredSearchFieldsList: [],
      remoteFilters: initialFilters,
      remoteOptions: remoteOptions,
      localOptions: [],
      localFilters: localFilters,
      popupFilterFields: props.popupFilterFields,
      tableName: moduleName,
      autoApply: false,
      addFilterStyle: "pt-4",
      filterButtonStyle: filterButtonStyle,
      defaultFilterKeys: props.defaultFilterKeys,
      customRightView: Caml_option.some(customFilters),
      customLeftView: Caml_option.some(customLeftView),
      updateUrlWith: props.updateUrlWith,
      clearFilters: clearFilters,
      initalCount: LogicUtils.isNonEmptyString(currentCustomFilterValue)
        ? 1
        : 0,
      showSelectFiltersSearch: showSelectFiltersSearch,
    }),
  );
}

var make = DynamicFilter;

export { CustomFilters, make };
/* Icon Not a pure module */
